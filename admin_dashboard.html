<!--
Project Name: Thronestead©
File Name: admin_dashboard.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Admin Dashboard | Thronestead</title>
  <meta name="author" content="Thronestead Moderation Team" />
  <meta name="version" content="7.1.2025.10.38" />

  <!-- Metadata -->
  <meta name="description" content="Admin Dashboard for Thronestead — View user metrics, suspicious activity, audit logs, and system tools." />
  <meta name="keywords" content="Admin Panel, Thronestead, Audit Logs, Flagged Users, Account Moderation, Admin Tools" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="canonical" href="https://www.thronestead.com/admin_dashboard.html" />

  <!-- Open Graph -->
  <meta property="og:title" content="Admin Dashboard | Thronestead" />
  <meta property="og:description" content="Command your administrative forces with full access to users, reports, flags, and control tools." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="https://www.thronestead.com/admin_dashboard.html" />
  <meta property="og:type" content="website" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Thronestead Admin Dashboard",
    "applicationCategory": "Moderation",
    "url": "https://www.thronestead.com/admin_dashboard.html"
  }
  </script>

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Admin Dashboard | Thronestead" />
  <meta name="twitter:description" content="Full-featured admin panel for account alerts, logs, moderation, and real-time tools in Thronestead." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- Global Assets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/admin_dashboard.css" rel="stylesheet" />
  <script type="module">
    window.requireAdmin = true;
  </script>

  <!-- Scripts -->
  <script type="module">
    // Project Name: Thronestead©
    // File Name: admin_dashboard.js (inlined)
    // Version: 7/1/2025 10:38
    // Developer: Deathsgift66

    import { escapeHTML, authJsonFetch, authFetch, showToast, debounce, safeUUID } from '/Javascript/utils.js';
    import { getAuth } from '/Javascript/auth.js';

    const REFRESH_MS = 30000;
    let rollbackAttempts = 0;
    let csrfToken = sessionStorage.getItem('csrf_token') || safeUUID();
    sessionStorage.setItem('csrf_token', csrfToken);
    document.cookie = `csrf_token=${csrfToken}; path=/; secure; samesite=strict`;
    const csrfPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    const isValidCsrf = token => csrfPattern.test(token);
    setInterval(() => {
      csrfToken = safeUUID();
      sessionStorage.setItem('csrf_token', csrfToken);
      document.cookie = `csrf_token=${csrfToken}; path=/; secure; samesite=strict`;
    }, 15 * 60 * 1000);

    async function setupAutoRefresh() {
      await loadDashboardStats();
      await loadFlaggedUsers();
      setInterval(async () => {
        await loadDashboardStats();
        await loadFlaggedUsers();
      }, REFRESH_MS);
    }

    let lastStats = {};
    async function loadDashboardStats() {
      try {
        const data = await authJsonFetch('/api/admin/stats');
        if (JSON.stringify(data) === JSON.stringify(lastStats)) return;
        lastStats = data;
        ['total-users', 'sum-users'].forEach(id => setText(id, data.active_users));
        ['flagged-users', 'sum-flags'].forEach(id => setText(id, data.flagged_users));
        setText('suspicious-activity', data.suspicious_count);
        setText('sum-wars', data.active_wars);
      } catch (e) {
        console.error('⚠️ Dashboard stats error:', e);
      }
    }

    async function loadPlayerList() {
      const q = document.getElementById('search-player')?.value.toLowerCase() || '';
      const status = document.getElementById('status-filter')?.value || '';
      const sort = document.getElementById('sort-order')?.value || 'username-asc';
      const container = document.getElementById('player-list');
      if (!container) return;

      container.innerHTML = '<p>Loading players...</p>';
      try {
        const url = new URL('/api/admin/search_user', window.location.origin);
        if (q) url.searchParams.set('q', q);
        if (status) url.searchParams.set('status', status);
        let players = await authJsonFetch(url);
        if (sort === 'username-desc') {
          players = players.sort((a, b) => b.username.localeCompare(a.username));
        } else {
          players = players.sort((a, b) => a.username.localeCompare(b.username));
        }
        container.innerHTML = players.length ? '' : '<p>No players found.</p>';

        players.forEach(p => {
          const card = document.createElement('div');
          card.className = 'player-card';
          card.innerHTML = `
            <p><strong>${escapeHTML(p.username)}</strong> (${escapeHTML(p.id)})</p>
            <p>Status: ${escapeHTML(p.status)}</p>
            <div class="player-actions">
              ${['flag', 'freeze', 'ban'].map(action =>
                `<button class="admin-btn" data-action="${action}" data-id="${escapeHTML(p.id)}">${capitalize(action)}</button>`
              ).join('')}
            </div>`;
          container.appendChild(card);
        });
      } catch (e) {
        console.error('⚠️ Player list error:', e);
        container.innerHTML = '<p class="error-msg">Failed to fetch players.</p>';
      }
    }

    async function loadAuditLogs(format = 'json') {
      const container = document.getElementById('log-list');
      if (!container) return;
      if (format === 'json') container.innerHTML = '<p>Loading logs...</p>';

      try {
        const url = new URL('/api/admin/audit/logs', window.location.origin);
        const type = document.getElementById('log-type')?.value.trim();
        const user = document.getElementById('log-user')?.value.trim();
        const startDate = document.getElementById('log-start')?.valueAsDate;
        const endDate = document.getElementById('log-end')?.valueAsDate;
        if (type) url.searchParams.set('search', type);
        if (user) url.searchParams.set('user_id', user);
        if (startDate) url.searchParams.set('start_date', startDate.toISOString());
        if (endDate) url.searchParams.set('end_date', endDate.toISOString());
        url.searchParams.set('format', format);

        if (format === 'csv') {
          const res = await authFetch(url);
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = 'audit_logs.csv';
          a.click();
          URL.revokeObjectURL(blobUrl);
          return;
        }

        const logs = await authJsonFetch(url);
        container.innerHTML = logs.length ? '' : '<p>No audit logs found.</p>';

        logs.forEach(log => {
          const entry = document.createElement('div');
          entry.className = 'log-card';
          entry.innerHTML = `
            <p><strong>${escapeHTML(log.action)}</strong> — ${escapeHTML(log.details)}</p>
            <p class="log-time">${formatTimestamp(log.created_at)}</p>`;
          container.appendChild(entry);
        });
      } catch (e) {
        console.error('⚠️ Logs error:', e);
        container.innerHTML = '<p class="error-msg">Failed to fetch audit logs.</p>';
      }
    }

    async function loadFlaggedUsers() {
      const container = document.getElementById('flagged-list');
      if (!container) return;
      container.innerHTML = '<p>Loading flagged players...</p>';

      try {
        const rows = await authJsonFetch('/api/admin/flagged_users');
        container.innerHTML = rows.length ? '' : '<p>No flagged users.</p>';

        rows.forEach(row => {
          const card = document.createElement('div');
          card.className = 'flagged-card';
          const icon = row.type === 'ban' ? '⛔' : '⚠️';
          card.innerHTML = `
            <p><span class="severity-icon">${icon}</span> <strong>${escapeHTML(row.user_id)}</strong> — ${escapeHTML(row.type)}</p>
            <p>${formatTimestamp(row.created_at)}</p>`;
          container.appendChild(card);
        });
      } catch (e) {
        console.error('❌ Flagged load error:', e);
        container.innerHTML = '<p>Error loading flagged users.</p>';
      }
    }

    async function loadFlags() {
      const table = document.getElementById('flag-table');
      if (!table) return;
      table.innerHTML = '<tr><td>Loading...</td></tr>';
      try {
        const rows = await authJsonFetch('/api/admin/flags');
        table.innerHTML = rows
          .map(r => `<tr><td>${escapeHTML(r.flag_key)}</td><td>${escapeHTML(String(r.flag_value))}</td></tr>`)
          .join('');
      } catch (e) {
        console.error('Flag table error:', e);
        table.innerHTML = '<tr><td colspan="2">Failed to load flags</td></tr>';
      }
    }

    async function initAlertSocket() {
      const container = document.getElementById('alerts');
      if (!container) return;
      container.innerHTML = '';
      const origin = window.location.origin || location.protocol + '//' + location.host;
      const { session } = await getAuth();
      const connect = await authJsonFetch('/api/admin/alerts/connect', {
        method: 'POST',
        headers: { 'X-CSRF-Token': csrfToken }
      });
      const { url: wsPath } = connect;
      const socket = new WebSocket(new URL(wsPath, origin).href.replace(/^http/, 'ws'));

      socket.onmessage = ({ data }) => {
        let alert;
        try {
          alert = JSON.parse(data);
        } catch (err) {
          console.error('Invalid alert payload', err);
          return;
        }
        const el = document.createElement('div');
        el.className = 'alert-item';
        el.innerHTML = `<b>${escapeHTML(alert.type)}</b>: ${escapeHTML(alert.message)} <small>${formatTimestamp(alert.timestamp)}</small>`;
        container.prepend(el);
      };

      socket.onerror = () => {
        console.error('❌ Alert socket error');
        container.innerHTML = '<p class="error-msg">Alert feed offline.</p>';
      };
    }

    async function handleAdminAction(endpoint, payload, msg, btn) {
      try {
        await postAdminAction(endpoint, payload);
        showToast(msg, 'success');
        if (btn) {
          btn.classList.add('flash-success');
          setTimeout(() => btn.classList.remove('flash-success'), 600);
        }
      } catch (err) {
        console.error('❌ Action failed:', err);
        showToast(`Action failed: ${err.message}`, 'error');
      }
    }

    async function postAdminAction(endpoint, payload) {
      if (!isValidCsrf(csrfToken)) throw new Error('Invalid session');
      const res = await authFetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
    }

    const actions = {
      'toggle-flag-btn': async btn => {
        const key = getValue('flag-key');
        const value = getValue('flag-value') === 'true';
        if (!key) return showToast('Enter a flag key', 'error');
        await handleAdminAction('/api/admin/flags/toggle', { flag_key: key, value }, 'Flag updated', btn);
      },
      'update-kingdom-btn': async btn => {
        const id = Number(getValue('kingdom-id'));
        const field = getValue('kingdom-field');
        const value = getValue('kingdom-value');
        if (!id || !field) return showToast('Missing field/kingdom', 'error');
        await handleAdminAction('/api/admin/kingdom/update_field', { kingdom_id: id, field, value }, 'Kingdom updated', btn);
      },
      'force-end-war-btn': async btn => {
        const id = Number(getValue('war-id'));
        if (!id) return showToast('Enter war ID', 'error');
        await handleAdminAction('/api/admin/war/force_end', { war_id: id }, 'War ended', btn);
      },
      'rollback-tick-btn': async btn => {
        const id = Number(getValue('war-id'));
        if (!id) return showToast('Enter war ID', 'error');
        await handleAdminAction('/api/admin/war/rollback_tick', { war_id: id }, 'Tick rolled back', btn);
      },
      'rollback-btn': async btn => {
        const pass = getValue('rollback-password');
        if (!pass) return showToast('Enter master password', 'error');
        if (!confirm('⚠️ Are you sure you want to rollback?')) return;
        try {
          await handleAdminAction('/api/admin/system/rollback', { password: pass }, 'Rollback triggered', btn);
          rollbackAttempts = 0;
        } catch (e) {
          if (++rollbackAttempts >= 3) {
            document.getElementById('rollback-btn').disabled = true;
            showToast('Rollback disabled after multiple failed attempts', 'error');
          }
          throw e;
        }
      },
      'create-event': async btn => {
        const name = prompt('Event name?');
        if (!name || !name.trim()) return showToast('Event name required', 'error');
        await handleAdminAction('/api/admin/events/create', { name: name.trim() }, 'Event created', btn);
      },
      'publish-news-btn': async btn => {
        const payload = ['title', 'summary', 'content'].reduce((acc, id) => {
          acc[id] = getValue(`news-${id}`).trim();
          return acc;
        }, {});
        if (!payload.title || !payload.summary || !payload.content) return showToast('Fill all news fields', 'error');
        await handleAdminAction('/api/admin/news/post', payload, 'News published', btn);
        ['title', 'summary', 'content'].forEach(id => (document.getElementById(`news-${id}`).value = ''));
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardStats();
      loadPlayerList();
      initAlertSocket();
      loadFlaggedUsers();
      loadFlags();
      setupAutoRefresh();

      const debouncedLoad = debounce(loadPlayerList, 400);

      document.getElementById('search-btn')?.addEventListener('click', debouncedLoad);
      document.getElementById('status-filter')?.addEventListener('change', debouncedLoad);
      document.getElementById('load-logs-btn')?.addEventListener('click', () => loadAuditLogs('json'));
      document.getElementById('export-csv')?.addEventListener('click', () => loadAuditLogs('csv'));

      Object.entries(actions).forEach(([id, fn]) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', () => fn(el));
      });
    });

    document.addEventListener('click', async e => {
      if (!e.target.classList.contains('admin-btn')) return;
      const id = e.target.dataset.id;
      const action = e.target.dataset.action;
      const map = {
        flag: ['/api/admin/flag', 'User flagged'],
        freeze: ['/api/admin/freeze', 'User frozen'],
        ban: ['/api/admin/ban', 'User banned']
      };
      if (map[action]) {
        if (!confirm(`Confirm ${capitalize(action)} for ${id}?`)) return;
        const [url, msg] = map[action];
        await handleAdminAction(url, { player_id: id }, msg, e.target);
      }
    });

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function getValue(id) {
      return document.getElementById(id)?.value || '';
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatTimestamp(ts) {
      try {
        if (!ts) return '';
        const d = new Date(ts);
        return isNaN(d) ? '' : d.toLocaleString();
      } catch {
        return '';
      }
    }
  </script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body data-theme="parchment">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navigation -->

  <!-- Page Header -->
  <header class="kr-top-banner" aria-label="Admin Dashboard Banner">
    Thronestead – Admin Dashboard
  </header>

  <div class="admin-summary-bar">
    <span>👥 Users: <strong id="sum-users">--</strong></span>
    <span>🧷 Flags: <strong id="sum-flags">--</strong></span>
    <span>💥 Active Wars: <strong id="sum-wars">--</strong></span>
  </div>

  <!-- Main Dashboard -->
  <main class="main-container" role="main" aria-label="Admin Tools Interface">
    <div class="container" id="admin-dashboard-content">
      <h2>Command your administrative forces. Monitor, manage, and moderate in real time.</h2>

      <!-- Live Statistics -->
      <section class="dashboard-stats" aria-label="Game Metrics Overview">
        <h3>Game Statistics</h3>
        <div class="stats">
          <div class="stat-card"><h4>Active Users</h4><p id="total-users">--</p></div>
          <div class="stat-card"><h4>Flagged Users</h4><p id="flagged-users">--</p></div>
          <div class="stat-card"><h4>Suspicious Activity</h4><p id="suspicious-activity">--</p></div>
        </div>
      </section>

      <!-- Flagged Players -->
      <section class="flagged-users" aria-label="Flagged Players">
        <h3>Flagged Players</h3>
        <div id="flagged-list" class="scrollable-panel" aria-live="polite"></div>
      </section>

      <!-- User Management -->
      <section class="user-management" aria-label="Player Moderation Tools">
        <h3>User Management</h3>
        <label for="search-player">Search Player</label>
        <input id="search-player" type="text" placeholder="Search by username" aria-label="Search Player" />
        <label for="status-filter">Status</label>
        <select id="status-filter" aria-label="User Status Filter">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="banned">Banned</option>
          <option value="frozen">Frozen</option>
        </select>
        <label for="sort-order">Sort</label>
        <select id="sort-order" aria-label="Sort Players">
          <option value="username-asc">Username A-Z</option>
          <option value="username-desc">Username Z-A</option>
        </select>
        <button id="search-btn">Search</button>
        <div id="player-list" class="scrollable-panel" aria-live="polite"></div>
      </section>

      <!-- Event Management -->
      <section class="event-management" aria-label="Global Event Tools">
        <h3>Event Tools</h3>
        <button class="action-btn" id="create-event">Create New Event</button>
      </section>

      <!-- News Publishing -->
      <section class="news-management" aria-label="Publish News">
        <h3>Publish News</h3>
        <label for="news-title">Title</label>
        <input id="news-title" type="text" placeholder="Title" aria-label="News Title" />
        <label for="news-summary">Summary</label>
        <input id="news-summary" type="text" placeholder="Summary" aria-label="News Summary" />
        <label for="news-content">Content</label>
        <textarea id="news-content" placeholder="Content" aria-label="News Content"></textarea>
        <button id="publish-news-btn">Publish</button>
      </section>

      <!-- System Flags -->
      <section class="flag-management" aria-label="System Flag Controls">
        <h3>System Flags</h3>
        <label for="flag-key">Flag key</label>
        <input id="flag-key" type="text" placeholder="Flag key" aria-label="System Flag Key" />
        <label for="flag-value">Flag value</label>
        <select id="flag-value" aria-label="Flag Value">
          <option value="true">True</option>
          <option value="false">False</option>
        </select>
        <button id="toggle-flag-btn">Toggle</button>
        <table id="flag-table"></table>
      </section>

      <!-- Kingdom Tools -->
      <section class="kingdom-management" aria-label="Kingdom Editing Tools">
        <h3>Kingdom Update</h3>
        <label for="kingdom-id">Kingdom ID</label>
        <input id="kingdom-id" type="number" min="1" required placeholder="Kingdom ID" aria-label="Kingdom ID" />
        <label for="kingdom-field">Field</label>
        <input id="kingdom-field" type="text" placeholder="Field" aria-label="Field Name" />
        <label for="kingdom-value">Value</label>
        <input id="kingdom-value" type="text" placeholder="Value" aria-label="Field Value" />
        <button id="update-kingdom-btn">Update</button>
      </section>

      <!-- War Controls -->
      <section class="war-management" aria-label="War Control Tools">
        <h3>War Controls</h3>
        <label for="war-id">War ID</label>
        <input id="war-id" type="number" min="1" required placeholder="War ID" aria-label="War ID" />
        <button id="force-end-war-btn">Force End War</button>
        <button id="rollback-tick-btn">Rollback Combat Tick</button>
      </section>

      <!-- System Rollback -->
      <section class="data-rollback" aria-label="Emergency Rollback Tool">
        <h3>Database Rollback</h3>
        <label for="rollback-password">Master Password</label>
        <input id="rollback-password" type="password" required placeholder="Master Password" aria-label="Admin Password" aria-describedby="rollback-tooltip" />
        <button id="rollback-btn" class="danger-btn tooltip-container">Trigger Rollback
          <span id="rollback-tooltip" class="tooltip-text">Reverts the database to the last backup. Use cautiously.</span>
        </button>
      </section>

      <!-- Audit Logs -->
      <section class="audit-logs" aria-label="System Audit Logs">
        <h3>Audit Logs</h3>
        <label for="log-type">Type</label>
        <input id="log-type" type="text" placeholder="Type" aria-label="Log Type" />
        <label for="log-user">User ID</label>
        <input id="log-user" type="text" placeholder="User ID" aria-label="User ID" />
        <label for="log-start">Start Date</label>
        <input id="log-start" type="date" aria-label="Start Date" />
        <label for="log-end">End Date</label>
        <input id="log-end" type="date" aria-label="End Date" />
        <button id="load-logs-btn">Load Logs</button>
        <button id="export-csv">Export CSV</button>
        <div id="log-list" class="scrollable-panel" aria-live="polite"></div>
      </section>

      <!-- Real-Time Alerts -->
      <section class="account-alerts" aria-label="Live Account Alerts">
        <h3>Account Alerts</h3>
        <div id="alerts" class="scrollable-panel" aria-live="polite"></div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div class="build-info">Version 7.1.2025.10.38</div>
    <div>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">Legal</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>
</body>

</html>
