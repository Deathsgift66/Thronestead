<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forgot Password | Thronestead</title>
  <meta name="description" content="Request a password reset link for your Thronestead account." />
  <link rel="canonical" href="https://www.thronestead.com/forgot.html" />
  <link href="/CSS/forgot_password.css" rel="stylesheet" />
  <script type="module">
    import { supabase } from '/supabaseClient.js';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('forgot-form');
      const emailInput = document.getElementById('forgot-email');
      const message = document.getElementById('forgot-message');
      const button = form.querySelector('button');

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const email = emailInput.value.trim();
        if (!email) {
          message.textContent = 'Please enter a valid email.';
          return;
        }
        button.disabled = true;
        try {
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: 'https://www.thronestead.com/update-password.html'
          });
          message.textContent = error ? `Error: ${error.message}` : 'Reset link sent! Check your email.';
        } catch (err) {
          message.textContent = `Unexpected error: ${err.message}`;
        } finally {
          button.disabled = false;
        }
      });
    });
  </script>
  <!-- <script src="/Javascript/themeToggle.js" type="module"></script> -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
</head>
<body>
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

  <main class="forgot-password-container" aria-label="Forgot Password Page">
    <div class="forgot-panel">
      <h1 class="login-title">Forgot Password</h1>
      <p class="forgot-instructions">Enter your email to receive a reset link.</p>
      <form id="forgot-form" class="forgot-form">
        <input type="email" id="forgot-email" placeholder="Your Royal Email" required />
        <button type="submit" class="royal-button">Send Reset Link</button>
      </form>
      <div id="forgot-message" class="message" aria-live="polite"></div>
      <div class="account-links"><a href="login.html">&larr; Back to Login</a></div>
      <!-- <button id="theme-toggle" class="royal-button" type="button">Dark Mode</button> -->
    </div>
  </main>
  <!-- Backend route definition for reference -->
  <script type="text/python">
from fastapi import APIRouter, Depends, HTTPException, Request, status
from sqlalchemy.orm import Session
import time
import uuid

from ..database import get_db
from backend.models import User
from services.email_service import send_email

router = APIRouter(prefix="/api/auth", tags=["auth"])

@router.post("/request-password-reset", status_code=status.HTTP_201_CREATED)
def request_password_reset(payload: EmailPayload, request: Request, db: Session = Depends(get_db)):
    _prune_expired()
    ip = request.client.host if request.client else ""
    history = RATE_LIMIT.setdefault(ip, [])
    if len(history) >= RATE_LIMIT_MAX:
        raise HTTPException(status_code=429, detail="Too many requests")
    history.append(time.time())

    user = db.query(User).filter(User.email == payload.email).first()
    if user:
        uid = str(user.user_id)
        user_hist = USER_RATE_LIMIT.setdefault(uid, [])
        if len(user_hist) >= RATE_LIMIT_MAX:
            raise HTTPException(status_code=429, detail="Too many requests")
        user_hist.append(time.time())
        token = uuid.uuid4().hex
        token_hash = _hash_token(token)
        RESET_STORE[token_hash] = (str(user.user_id), time.time() + TOKEN_TTL)

        send_email(user.email, subject="Reset Code", body=token)
        logger.info("Reset requested for %s", mask_email(user.email))

    return {"message": "If the email exists, a reset link has been sent."}
  </script>
</body>
</html>
