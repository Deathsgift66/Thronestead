<!--
Project Name: Thronestead©
File Name: alliance_vault.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alliance Vault | Thronestead</title>

  <!-- Metadata -->
  <meta name="description" content="Manage your Alliance Vault in Thronestead — deposit, withdraw, and review vault history." />
  <meta name="keywords" content="Thronestead, alliance vault, treasury, resources, economy" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.thronestead.com/alliance_vault.html" />

  <!-- Open Graph & Twitter -->
  <meta property="og:title" content="Alliance Vault | Thronestead" />
  <meta property="og:description" content="Manage your Alliance Vault in Thronestead — deposit, withdraw, and review vault history." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="alliance_vault.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alliance Vault | Thronestead" />
  <meta name="twitter:description" content="Manage your Alliance Vault — deposit, withdraw, and audit resources." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- Stylesheets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/alliance_vault.css" rel="stylesheet" />

  <!-- Scripts -->
  <script type="module" src="/Javascript/requireAlliance.js"></script>
  <script src="/Javascript/allianceAppearance.js" type="module"></script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navbar -->

  <!-- Page Banner -->
  <header class="kr-top-banner" aria-label="Vault Management Page Header">
    Thronestead — Alliance Vault
  </header>

  <!-- Main Vault Container -->
  <main class="main-centered-container" aria-label="Alliance Vault Interface">
    <!-- Visual Branding -->
    <div class="alliance-visuals">
      <img class="alliance-banner" src="Assets/banner.png" alt="Alliance Banner" />
      <img class="alliance-emblem" src="Assets/avatars/default_avatar_emperor.png" alt="Alliance Emblem" />
    </div>

    <!-- Custom Section -->
    <section class="alliance-customization-area" aria-label="Vault Board Appearance">
      <h2>Customize Vault Board</h2>
      <div id="custom-image-slot" aria-label="Vault Custom Image"></div>
      <div id="custom-text-slot" aria-label="Vault Custom Text"></div>
    </section>

    <!-- Vault Management Tabs -->
    <section class="alliance-members-container" aria-label="Vault Controls">
      <h2>Alliance Vault</h2>

      <nav class="tab-control-bar" role="tablist" aria-label="Vault Sections">
        <button class="tab-button active" data-tab="tab-manage" role="tab" aria-selected="true">Manage Vault</button>
        <button class="tab-button" data-tab="tab-transactions" role="tab" aria-selected="false">Transactions</button>
      </nav>

      <!-- Manage Tab -->
      <div id="tab-manage" class="tab-section active" role="tabpanel">
        <p>Securely manage alliance resources — deposit, withdraw, and track treasury activity.</p>

        <!-- Vault Totals -->
        <div class="vault-summary panel" aria-label="Vault Resource Totals">
          <!-- JS Injected Resource Display -->
        </div>

        <!-- Deposit Form -->
        <div class="panel">
          <h3 class="panel-title">Deposit Resources</h3>
          <div id="deposit-section" aria-label="Deposit Interface">
            <!-- JS Injected Deposit UI -->
          </div>
          <p>Manage tax policies to automate deposits.</p>
        </div>

        <!-- Withdraw Form -->
        <div class="panel">
          <h3 class="panel-title">Withdraw Resources</h3>
          <div id="withdraw-section" aria-label="Withdraw Interface">
            <!-- JS Injected Withdraw UI -->
          </div>
        </div>
      </div>

      <!-- Transaction Log Tab -->
      <div id="tab-transactions" class="tab-section" role="tabpanel" hidden>
        <div class="panel">
          <h3 class="panel-title">Vault Transactions</h3>

          <!-- Filters -->
          <div class="filter-toolbar" aria-label="Transaction Filters">
            <label for="filter-action">Filter:</label>
            <select id="filter-action">
              <option value="">All</option>
              <option value="deposit">Deposits</option>
              <option value="withdraw">Withdrawals</option>
              <option value="transfer">Transfers</option>
              <option value="trade">Trades</option>
            </select>

            <label for="filter-days">Time:</label>
            <select id="filter-days">
              <option value="">All</option>
              <option value="1">Last Day</option>
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
            </select>

            <button id="apply-trans-filter" class="action-btn">Apply</button>
          </div>

          <!-- Table -->
          <div class="transaction-table custom-scrollbar">
            <table>
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Player</th>
                  <th>Action</th>
                  <th>Resource</th>
                  <th>Amount</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="vault-history" aria-live="polite">
                <!-- JS Injected Transaction Logs -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div><a href="legal.html" target="_blank">View Legal Documents</a> <a href="sitemap.xml" target="_blank">Site Map</a></div>
  </footer>

  <!-- Tab interactivity handled by inline script -->
  <script type="module">
    import { supabase } from './supabaseClient.js';
    import { RESOURCE_TYPES } from './Javascript/resourceTypes.js';
    import { loadCustomBoard } from './Javascript/customBoard.js';
    import { escapeHTML, authFetch } from './Javascript/utils.js';
    import { setupTabs } from './Javascript/components/tabControl.js';

    let currentUser = null;
    const maxVault = 100000; // TODO: fetch dynamically
    let currentFilters = { action: '', days: '' };

    function subscribeToVault(allianceId) {
      supabase
        .channel(`vault_${allianceId}`)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'alliance_vault_transaction_log',
            filter: `alliance_id=eq.${allianceId}`
          },
          async () => {
            await loadVaultSummary();
            await loadTransactions();
          }
        )
        .subscribe();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const {
        data: { user }
      } = await supabase.auth.getUser();
      if (!user) return (window.location.href = 'login.html');
      currentUser = user;

      setupTabs({ onShow: id => id === 'tab-transactions' && loadTransactions(currentFilters.action, currentFilters.days) });
      await Promise.all([
        loadVaultSummary(),
        loadCustomBoard({ endpoint: '/api/alliance/custom/vault', fetchFn: authFetch }),
        loadDepositForm(),
        loadWithdrawForm(),
        loadTransactions()
      ]);

      const { data: allianceData } = await supabase
        .from('users')
        .select('alliance_id')
        .eq('user_id', user.id)
        .single();

      if (allianceData?.alliance_id) {
        subscribeToVault(allianceData.alliance_id);
      }

      try {
        const res = await authFetch('/api/alliance-members/view');
        const json = await res.json();
        const me = (json.alliance_members || []).find(m => m.user_id === currentUser.id);
        if (!me || !(me.can_manage_resources || me.permissions?.can_manage_resources)) {
          document.getElementById('withdraw-section').style.display = 'none';
        }
      } catch (err) {
        console.error('Permission check failed:', err);
      }

      document.getElementById('apply-trans-filter')?.addEventListener('click', () => {
        currentFilters.action = document.getElementById('filter-action')?.value || '';
        currentFilters.days = document.getElementById('filter-days')?.value || '';
        loadTransactions(currentFilters.action, currentFilters.days);
      });
    });

    function renderVaultSummary(data) {
      const container = document.querySelector('.vault-summary');
      container.innerHTML = Object.entries(data)
        .map(([key, value]) => {
          const label = escapeHTML(key.replaceAll('_', ' '));
          return `
      <div class="progress-bar">
        <label>${label}</label>
        <progress value="${value}" max="${maxVault}"></progress>
        <span>${value.toLocaleString()}</span>
      </div>
    `;
        })
        .join('');
    }

    async function loadVaultSummary() {
      const container = document.querySelector('.vault-summary');
      container.innerHTML = '<p>Loading vault totals...</p>';
      try {
        const res = await authFetch('/api/vault/resources');
        const { totals } = await res.json();
        if (!totals || Object.keys(totals).length === 0) {
          container.innerHTML = '<p>No resources in vault.</p>';
          return;
        }
        renderVaultSummary(totals);
      } catch (err) {
        console.error('❌ Vault Summary:', err);
        container.innerHTML = '<p>Failed to load vault totals.</p>';
      }
    }

    function buildResourceInputForm(type, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
    <form id="${type}-form" class="resource-form">
      ${RESOURCE_TYPES.map(
        r => `
        <div class="resource-input-row">
          <label>${r}</label>
          <input type="number" min="0" name="${r}" data-type="${type}" />
        </div>
      `
      ).join('')}
      <button class="action-btn" type="submit">${type === 'deposit' ? 'Deposit' : 'Withdraw'}</button>
    </form>
  `;

      document.getElementById(`${type}-form`).addEventListener('submit', async e => {
        e.preventDefault();
        const inputs = Array.from(
          document.querySelectorAll(`#${type}-form input[data-type='${type}']`)
        );
        const payloads = inputs
          .map(i => ({ res: i.name.toLowerCase().replace(/ /g, '_'), amt: parseInt(i.value) || 0 }))
          .filter(p => p.amt > 0);
        if (!payloads.length) return alert('Enter amounts.');
        for (const p of payloads) {
          if (type === 'withdraw' && p.amt > 1000) {
            if (!confirm(`Withdraw ${p.amt} ${p.res}?`)) continue;
          }
          try {
            await authFetch(`/api/alliance/vault/${type}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ resource: p.res, amount: p.amt })
            });
          } catch (err) {
            console.error(`❌ ${type}:`, err);
          }
        }
        await loadVaultSummary();
        await loadTransactions();
        inputs.forEach(i => {
          i.value = '';
        });
        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} complete.`);
      });
    }

    function loadDepositForm() {
      buildResourceInputForm('deposit', 'deposit-section');
    }

    function loadWithdrawForm() {
      buildResourceInputForm('withdraw', 'withdraw-section');
    }

    async function loadTransactions(action = '', days = '') {
      const tbody = document.getElementById('vault-history');
      tbody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;

      try {
        const params = new URLSearchParams();
        action = action || document.getElementById('filter-action')?.value || '';
        days = days || document.getElementById('filter-days')?.value || '';
        if (action) params.append('action', action);
        if (days) params.append('days', days);

        const res = await authFetch(`/api/alliance/vault/transactions?${params}`);
        const logs = await res.json();
        const history = logs || [];

        tbody.innerHTML = '';
        if (!history.length) {
          tbody.innerHTML = `<tr><td colspan="6">No transactions found.</td></tr>`;
          return;
        }

        history.forEach(log => {
          const row = document.createElement('tr');
          row.innerHTML = `
        <td>${new Date(log.timestamp || log.created_at).toLocaleString()}</td>
        <td>${escapeHTML(log.user || log.username || log.user_id || 'System')}</td>
        <td>${escapeHTML(log.action)}</td>
        <td>${escapeHTML(log.resource_type)}</td>
        <td>${log.amount}</td>
        <td>${escapeHTML(log.notes || '-')}</td>
      `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('❌ Vault History:', err);
        tbody.innerHTML = `<tr><td colspan="6">Failed to load history.</td></tr>`;
      }
    }
  </script>
</body>
</html>
