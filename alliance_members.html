<!-- Project Name: Thronestead© -->
<!-- File Name: alliance_members.html -->
<!-- Version: 7/1/2025 -->
<!-- Developer: Deathsgift66 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Alliance Members | Thronestead</title>
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/alliance_members.css" rel="stylesheet" />
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
  <script type="module">
    import { supabase } from '/Javascript/supabaseClient.js';
    import { escapeHTML, showToast, toggleLoading, debounce } from '/Javascript/utils.js';

    const RANK_TOOLTIPS = {
      Leader: 'Alliance leader with full authority',
      'Co-Leader': 'Second in command',
      'War Officer': 'Manages wartime efforts',
      Diplomat: 'Handles treaties and diplomacy',
      Member: 'Standard member'
    };

    const rankPower = ['Member', 'Diplomat', 'War Officer', 'Co-Leader', 'Leader'];
    const rankPowerNormalized = rankPower.map(r => r.toLowerCase());
    let members = [];
    let membersChannel = null;
    let currentUser = null;
    let authToken = '';
    let csrfToken = sessionStorage.getItem('csrf_token') || crypto.randomUUID();
    sessionStorage.setItem('csrf_token', csrfToken);

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      authToken = session?.access_token || '';
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if (!(await enforceAllianceOrAdminAccess())) return;
      const sortBy = document.getElementById('sort-by')?.value || 'username';
      const direction = document.getElementById('sort-direction')?.value || 'asc';
      await fetchMembers(sortBy, direction);
      setupUIControls();
      setupRealtime();
    });

    supabase.auth.onAuthStateChange((_event, session) => {
      authToken = session?.access_token || '';
      currentUser = session?.user || null;
      if (!session && membersChannel) {
        supabase.removeChannel(membersChannel);
        membersChannel = null;
      }
    });

    async function enforceAllianceOrAdminAccess() {
      try {
        if (!currentUser) return redirectToLogin();
        const [admin, alliance] = await Promise.all([
          supabase.from('users').select('is_admin').eq('user_id', currentUser.id).single(),
          supabase.from('alliance_members').select('user_id').eq('user_id', currentUser.id).maybeSingle()
        ]);
        if (admin.error) console.error(admin.error.message || admin.error);
        if (alliance.error) console.error(alliance.error.message || alliance.error);
        if (admin.data?.is_admin || alliance.data) return true;
        showToast('You must be in an alliance or be an admin to access this page.', 'error');
        window.location.href = 'overview.html';
        return false;
      } catch (err) {
        console.error('❌ Access check error:', err);
        window.location.href = 'overview.html';
        return false;
      }
    }

    function redirectToLogin() {
      window.location.href = 'login.html';
      return false;
    }

    async function fetchMembers(sortBy = 'username', direction = 'asc', search = '') {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="11"><div class="loading-spinner"></div></td></tr>`;
      toggleLoading(true);
      try {
        const url = new URL('/api/alliance/members', window.location.origin);
        const validSort = ['username','rank','contribution','status','military_score','economy_score','diplomacy_score','total_output'];
        if (!validSort.includes(sortBy)) sortBy = 'username';
        const validDir = ['asc','desc'];
        if (!validDir.includes(direction.toLowerCase())) direction = 'asc';
        const sanitizedSearch = search.replace(/[^\w\s-]/g, '').slice(0,50);
        url.searchParams.set('sort_by', sortBy);
        url.searchParams.set('direction', direction);
        if (sanitizedSearch) url.searchParams.set('search', sanitizedSearch);
        const res = await fetch(url, {
          headers: {
            'X-User-ID': currentUser.id,
            'Authorization': `Bearer ${authToken}`
          }
        });
        if (res.status === 403) {
          redirectToLogin();
          return;
        }
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        members = await res.json();
        renderMembers(members);
      } catch (err) {
        console.error('❌ Member fetch error:', err);
        tbody.innerHTML = `<tr><td colspan="11">Failed to load members.</td></tr>`;
      } finally {
        toggleLoading(false);
      }
    }

    function setupUIControls() {
      const btn = document.getElementById('apply-sort');
      if (!btn) return;
      const handler = debounce(async () => {
        btn.disabled = true;
        const original = btn.textContent;
        btn.innerHTML = '<div class="loading-spinner"></div>';
        const keyword = document.getElementById('member-search')?.value.toLowerCase() || '';
        const sortBy = document.getElementById('sort-by')?.value || 'username';
        const direction = document.getElementById('sort-direction')?.value || 'asc';
        await fetchMembers(sortBy, direction, keyword);
        btn.disabled = false;
        btn.textContent = original;
      }, 300);
      btn.addEventListener('click', handler);
    }

    function setupRealtime() {
      membersChannel = supabase
        .channel('public:alliance_members')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'alliance_members'
        }, async () => await fetchMembers())
        .subscribe();

      window.addEventListener('beforeunload', async () => {
        if (membersChannel) {
          await supabase.removeChannel(membersChannel);
          membersChannel = null;
        }
      });
    }

    async function renderMembers(data) {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;
      tbody.innerHTML = '';
      const { isAdmin, userRank, userId } = await getUserPrivileges();
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="empty-state">No matching members found.</td></tr>`;
        return;
      }

      const rankLevel = r => rankPowerNormalized.indexOf((r || 'member').toLowerCase());
      data.forEach(member => {
        const row = document.createElement('tr');
        if (member.rank === 'Leader') row.classList.add('leader-row');
        const canManage = isAdmin || rankLevel(userRank) > rankLevel(member.rank);
        const showFull = member.same_alliance;
        row.innerHTML = `
          <td><img src="/Assets/crests/${escapeHTML(member.crest || 'default.png')}" class="crest-icon" alt="Crest" onerror="this.src='/Assets/crests/default.png'"></td>
          <td><a href="kingdom_profile.html?kingdom_id=${member.kingdom_id}">${escapeHTML(member.username)}</a>${member.is_vip ? ' ⭐' : ''}</td>
          <td title="${escapeHTML(RANK_TOOLTIPS[member.rank] || '')}">${escapeHTML(member.rank)}</td>
          <td>${showFull ? roleBadge(member) : '—'}</td>
          <td>${showFull ? escapeHTML(member.status) : '—'}</td>
          <td>${showFull ? member.contribution : '—'}</td>
          <td>${showFull ? member.economy_score : '—'}</td>
          <td>${showFull ? member.military_score : '—'}</td>
          <td>${showFull ? member.diplomacy_score : '—'}</td>
          <td>${showFull ? member.total_output : '—'}</td>
          <td>${canManage ? renderActions(member, userRank.toLowerCase(), userId) : '—'}</td>
        `;
        tbody.appendChild(row);
      });

      tbody.addEventListener('click', async e => {
        const btn = e.target.closest('button');
        if (!btn || btn.disabled) return;
        const userId = btn.dataset.id;
        btn.disabled = true;
        try {
          if (btn.classList.contains('promote-btn')) await promoteMember(userId);
          else if (btn.classList.contains('demote-btn')) await demoteMember(userId);
          else if (btn.classList.contains('kick-btn')) await removeMember(userId);
          else if (btn.classList.contains('transfer-btn')) await transferLeadership(userId);
        } finally {
          setTimeout(() => {
            btn.disabled = false;
          }, 3000);
        }
      });
    }

    async function getUserPrivileges() {
      const user = currentUser;
      const [admin, rank] = await Promise.all([
        supabase.from('users').select('is_admin').eq('user_id', user.id).single(),
        supabase.from('alliance_members').select('rank').eq('user_id', user.id).maybeSingle()
      ]);
      if (admin.error) console.error(admin.error.message || admin.error);
      if (rank.error) console.error(rank.error.message || rank.error);
      return {
        isAdmin: admin.data?.is_admin || false,
        userRank: rank.data?.rank || '',
        userId: user.id
      };
    }

    function renderActions(member, currentRole, currentUserId) {
      const actions = [];
      if (member.user_id === currentUserId) return '';
      const memberLevel = rankLevel(member.rank);
      const currentLevel = rankLevel(currentRole);
      if (currentLevel <= memberLevel) return '';

      if (currentRole === 'leader') {
        if (member.rank.toLowerCase() !== 'leader') {
          if (memberLevel < rankPower.length - 1) {
            actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
          }
          if (memberLevel > 0) {
            actions.push(`<button data-id="${member.user_id}" class="demote-btn">Demote</button>`);
          }
          actions.push(`<button data-id="${member.user_id}" class="kick-btn danger-btn">Kick</button>`);
          actions.push(`<button data-id="${member.user_id}" class="transfer-btn">Transfer Leadership</button>`);
        }
      } else if (currentRole === 'war officer' && member.rank.toLowerCase() === 'member') {
        actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
        actions.push(`<button data-id="${member.user_id}" class="kick-btn">Kick</button>`);
      }
      return actions.join(' ');
    }

    function roleBadge(member) {
      const cls = (member.rank || '')
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '');
      const icons = { leader: '👑', officer: '🛡' };
      const icon = icons[cls] || '';
      const label = member.role || member.rank || '';
      return `<span class="badge role-badge ${cls}">${icon ? icon + ' ' : ''}${escapeHTML(label)}</span>`;
    }

    async function confirmAndPost(endpoint, payload, successMsg, hardConfirm = false) {
      const confirmed = confirm(hardConfirm ? 'Are you sure? This cannot be undone.' : 'Are you sure you want to proceed?');
      if (!confirmed) return;
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': currentUser.id,
            'Authorization': `Bearer ${authToken}`,
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify(payload)
        });
        if (res.status === 403) {
          redirectToLogin();
          return;
        }
        if (!res.ok) throw new Error(await res.text());
        showToast(`✅ ${successMsg}`, 'success');
        fetchMembers();
      } catch (err) {
        console.error('❌ Action failed:', err);
        showToast(`❌ Failed: ${err.message}`, 'error');
      }
    }

    const promoteMember = id => confirmAndPost('/api/alliance_members/promote', { user_id: id }, 'Member promoted.');
    const demoteMember = id => confirmAndPost('/api/alliance_members/demote', { user_id: id }, 'Member demoted.');
    const removeMember = id => confirmAndPost('/api/alliance_members/remove', { user_id: id }, 'Member removed.', true);
    const transferLeadership = id => {
      const confirmName = prompt('Type TRANSFER to confirm leadership transfer:');
      if (confirmName !== 'TRANSFER') return;
      confirmAndPost('/api/alliance_members/transfer_leadership', { new_leader_id: id }, 'Leadership transferred.', true);
    };
  </script>
</head>
<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.</div>
  </noscript>

  <div id="navbar-container"></div>
  <div id="resource-bar-container"></div>

  <main>
    <section class="search-sort-controls" aria-label="Member search and sort">
      <input type="text" id="member-search" placeholder="Search username" aria-label="Search Username" />
      <select id="sort-by" aria-label="Sort by">
        <option value="username">Username</option>
        <option value="rank">Rank</option>
        <option value="contribution">Contribution</option>
        <option value="economy_score">Economy</option>
        <option value="military_score">Military</option>
        <option value="diplomacy_score">Diplomacy</option>
        <option value="total_output">Output</option>
      </select>
      <select id="sort-direction" aria-label="Sort direction">
        <option value="asc">Asc</option>
        <option value="desc">Desc</option>
      </select>
      <button id="apply-sort">Apply</button>
    </section>

    <div class="members-table-container">
      <table class="members-table">
        <caption class="sr-only">Alliance members</caption>
        <thead>
          <tr>
            <th scope="col">Crest</th>
            <th scope="col">Name</th>
            <th scope="col">Rank</th>
            <th scope="col">Role</th>
            <th scope="col">Status</th>
            <th scope="col">Contribution</th>
            <th scope="col">Economy</th>
            <th scope="col">Military</th>
            <th scope="col">Diplomacy</th>
            <th scope="col">Output</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="members-list" aria-live="polite">
          <tr><td colspan="11"><div class="loading-spinner"></div></td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <div id="toast" class="toast-notification" role="status" aria-live="polite" aria-hidden="true" tabindex="-1"></div>
  <div id="loading-overlay" aria-hidden="true"><div class="spinner"></div></div>

  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div><a href="legal.html" target="_blank">Legal</a> <a href="sitemap.xml" target="_blank">Sitemap</a></div>
  </footer>
</body>
</html>
