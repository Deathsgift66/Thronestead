<!--
Project Name: Thronestead©
File Name: alliance_members.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Alliance Members | Thronestead</title>

  <!-- Metadata -->
  <meta name="description" content="Manage your alliance members, promote, demote, or remove members in Thronestead." />
  <meta name="keywords" content="Thronestead, alliance members, management, strategy game, kingdom MMO" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.thronestead.com/alliance_members.html" />

  <!-- Open Graph & Twitter -->
  <meta property="og:title" content="Alliance Members | Thronestead" />
  <meta property="og:description" content="Alliance management dashboard to control ranks, statuses, and actions." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="alliance_members.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alliance Members | Thronestead" />
  <meta name="twitter:description" content="Manage your alliance members, promote, demote, or remove members in Thronestead." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- Stylesheets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/alliance_members.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet" />

  <!-- Scripts -->
  <script type="module">
    import { supabase } from '/Javascript/supabaseClient.js';

    const DEFAULT_BANNER = '/Assets/banner.png';

    async function applyAllianceAppearance() {
      try {
        const { data: { session } = {} } = await supabase.auth.getSession();
        const userId = session?.user?.id;
        if (!userId) return;

        const res = await fetch('/api/alliance-home/details', {
          headers: { 'X-User-ID': userId }
        });
        if (!res.ok) return;

        const { alliance } = await res.json();
        if (!alliance) return;

        const banner = alliance.banner || DEFAULT_BANNER;
        const emblem = alliance.emblem_url;

        document.querySelectorAll('.alliance-banner').forEach(img => {
          img.src = banner;
        });

        if (emblem) {
          document.querySelectorAll('.alliance-emblem').forEach(img => {
            img.src = emblem;
          });
        }

        document.querySelectorAll('.alliance-bg').forEach(el => {
          el.style.backgroundImage = `url(${banner})`;
          el.style.backgroundSize = 'cover';
          el.style.backgroundAttachment = 'fixed';
          el.style.backgroundRepeat = 'no-repeat';
          el.style.backgroundPosition = 'center';
        });

      } catch (err) {
        console.error('❌ Failed to apply alliance appearance:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', applyAllianceAppearance);
  </script>
  <script type="module">
    import { supabase } from '/Javascript/supabaseClient.js';
    import { escapeHTML } from '/Javascript/utils.js';

    const RANK_TOOLTIPS = {
      Leader: 'Alliance leader with full authority',
      'Co-Leader': 'Second in command',
      'War Officer': 'Manages wartime efforts',
      Diplomat: 'Handles treaties and diplomacy',
      Member: 'Standard member'
    };

    const rankPower = ['Member', 'Diplomat', 'War Officer', 'Co-Leader', 'Leader'];
    let members = [];
    let membersChannel = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!(await enforceAllianceOrAdminAccess())) return;

      const sortBy = document.getElementById('sort-by')?.value || 'username';
      const direction = document.getElementById('sort-direction')?.value || 'asc';
      await fetchMembers(sortBy, direction);

      setupUIControls();
      setupRealtime();
    });

    async function enforceAllianceOrAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return redirectToLogin();

        const [admin, alliance] = await Promise.all([
          supabase.from('users').select('is_admin').eq('user_id', user.id).single(),
          supabase.from('alliance_members').select('user_id').eq('user_id', user.id).maybeSingle()
        ]);

        if (admin.data?.is_admin || alliance.data) return true;
        alert('You must be in an alliance or be an admin to access this page.');
        window.location.href = 'overview.html';
        return false;
      } catch (err) {
        console.error('❌ Access check error:', err);
        window.location.href = 'overview.html';
        return false;
      }
    }

    function redirectToLogin() {
      window.location.href = 'login.html';
      return false;
    }

    async function fetchMembers(sortBy = 'username', direction = 'asc', search = '') {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;

      tbody.innerHTML = `<tr><td colspan="11">Loading members...</td></tr>`;

      try {
        const { data: { user } } = await supabase.auth.getUser();
        const url = new URL('/api/alliance/members', window.location.origin);
        url.searchParams.set('sort_by', sortBy);
        url.searchParams.set('direction', direction);
        if (search) url.searchParams.set('search', search);

        const res = await fetch(url, { headers: { 'X-User-ID': user.id } });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        members = await res.json();
        renderMembers(members);
      } catch (err) {
        console.error('❌ Member fetch error:', err);
        tbody.innerHTML = `<tr><td colspan="11">Failed to load members.</td></tr>`;
      }
    }

    function setupUIControls() {
      document.getElementById('apply-sort')?.addEventListener('click', () => {
        const keyword = document.getElementById('member-search')?.value.toLowerCase() || '';
        const sortBy = document.getElementById('sort-by')?.value || 'username';
        const direction = document.getElementById('sort-direction')?.value || 'asc';
        fetchMembers(sortBy, direction, keyword);
      });
    }

    function setupRealtime() {
      membersChannel = supabase
        .channel('public:alliance_members')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'alliance_members'
        }, () => fetchMembers())
        .subscribe();

      window.addEventListener('beforeunload', () => {
        if (membersChannel) supabase.removeChannel(membersChannel);
      });
    }

    async function renderMembers(data) {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;

      tbody.innerHTML = '';

      const { isAdmin, userRank } = await getUserPrivileges();

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="empty-state">No matching members found.</td></tr>`;
        return;
      }

      const rankLevel = r => rankPower.indexOf(r || 'Member');

      data.forEach(member => {
        const row = document.createElement('tr');
        if (member.rank === 'Leader') row.classList.add('leader-row');

        const canManage = isAdmin || rankLevel(userRank) > rankLevel(member.rank);
        const showFull = member.same_alliance;

        row.innerHTML = `
          <td><img src="/assets/crests/${escapeHTML(member.crest || 'default.png')}" class="crest-icon" alt="Crest"></td>
          <td><a href="kingdom_profile.html?kingdom_id=${member.kingdom_id}">${escapeHTML(member.username)}</a>${member.is_vip ? ' ⭐' : ''}</td>
          <td title="${escapeHTML(RANK_TOOLTIPS[member.rank] || '')}">${escapeHTML(member.rank)}</td>
          <td>${showFull ? roleBadge(member) : '—'}</td>
          <td>${showFull ? escapeHTML(member.status) : '—'}</td>
          <td>${showFull ? member.contribution : '—'}</td>
          <td>${showFull ? member.economy_score : '—'}</td>
          <td>${showFull ? member.military_score : '—'}</td>
          <td>${showFull ? member.diplomacy_score : '—'}</td>
          <td>${showFull ? member.total_output : '—'}</td>
          <td>${canManage ? renderActions(member, userRank.toLowerCase()) : '—'}</td>
        `;

        tbody.appendChild(row);
      });

      tbody.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const userId = btn.dataset.id;
        if (btn.classList.contains('promote-btn')) promoteMember(userId);
        else if (btn.classList.contains('demote-btn')) demoteMember(userId);
        else if (btn.classList.contains('kick-btn')) removeMember(userId);
        else if (btn.classList.contains('transfer-btn')) transferLeadership(userId);
      }, { once: true });
    }

    async function getUserPrivileges() {
      const { data: { user } } = await supabase.auth.getUser();
      const [admin, rank] = await Promise.all([
        supabase.from('users').select('is_admin').eq('user_id', user.id).single(),
        supabase.from('alliance_members').select('rank').eq('user_id', user.id).maybeSingle()
      ]);
      return {
        isAdmin: admin.data?.is_admin || false,
        userRank: rank.data?.rank || '',
        userId: user.id
      };
    }

    function renderActions(member, currentRole) {
      const actions = [];
      if (currentRole === 'leader') {
        if (member.rank.toLowerCase() !== 'leader') {
          actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
          actions.push(`<button data-id="${member.user_id}" class="demote-btn">Demote</button>`);
          actions.push(`<button data-id="${member.user_id}" class="kick-btn danger-btn">Kick</button>`);
          actions.push(`<button data-id="${member.user_id}" class="transfer-btn">Transfer Leadership</button>`);
        }
      } else if (currentRole === 'officer' && member.rank.toLowerCase() === 'member') {
        actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
        actions.push(`<button data-id="${member.user_id}" class="kick-btn">Kick</button>`);
      }
      return actions.join(' ');
    }

    function roleBadge(member) {
      const cls = (member.rank || '').toLowerCase().replace(/\s+/g, '-');
      const icons = { leader: '👑', officer: '🛡' };
      const icon = icons[cls] || '';
      const label = member.role || member.rank || '';
      return `<span class="badge role-badge ${cls}">${icon ? icon + ' ' : ''}${escapeHTML(label)}</span>`;
    }

    async function confirmAndPost(endpoint, payload, successMsg, hardConfirm = false) {
      const confirmed = confirm(hardConfirm
        ? 'Are you sure? This cannot be undone.'
        : 'Are you sure you want to proceed?');
      if (!confirmed) return;

      try {
        const { data: { user } } = await supabase.auth.getUser();
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        alert(`✅ ${successMsg}`);
        fetchMembers();
      } catch (err) {
        console.error('❌ Action failed:', err);
        alert(`❌ Failed: ${err.message}`);
      }
    }

    const promoteMember = id => confirmAndPost('/api/alliance_members/promote', { user_id: id }, 'Member promoted.');
    const demoteMember = id => confirmAndPost('/api/alliance_members/demote', { user_id: id }, 'Member demoted.');
    const removeMember = id => confirmAndPost('/api/alliance_members/remove', { user_id: id }, 'Member removed.', true);
    const transferLeadership = id => confirmAndPost('/api/alliance_members/transfer_leadership', { new_leader_id: id }, 'Leadership transferred.');
  </script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navbar -->

  <!-- Page Header -->
  <header class="kr-top-banner" aria-label="Alliance Members Banner">
    Alliance Members
  </header>

  <!-- Main Content -->
  <main class="main-centered-container" aria-label="Alliance Member Management Dashboard">
    <div class="alliance-members-container">
      <!-- Visuals -->
      <div class="alliance-visuals">
        <img class="alliance-banner" src="Assets/banner.png" alt="Alliance Banner" />
        <img class="alliance-emblem" src="Assets/avatars/default_avatar_emperor.png" alt="Alliance Emblem" />
      </div>

      <h2>Alliance Roster Management</h2>

      <!-- Search and Sort Controls -->
      <section class="search-sort-controls" aria-label="Sort and Filter Alliance Members">
        <input type="text" id="member-search" placeholder="Search by name..." aria-label="Search Members" />

        <select id="sort-by" aria-label="Sort Members By">
          <option value="username">Name</option>
          <option value="rank">Rank</option>
          <option value="contribution">Contribution</option>
          <option value="status">Status</option>
          <option value="military_score">Military</option>
          <option value="economy_score">Economy</option>
          <option value="diplomacy_score">Diplomacy</option>
          <option value="total_output">Resource Output</option>
        </select>

        <select id="sort-direction" aria-label="Sort Order">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>

        <button id="apply-sort" class="btn">Apply Sort</button>
      </section>

      <!-- Members Table -->
      <section class="members-table-container" aria-label="Alliance Members Table">
        <table class="members-table">
          <caption class="sr-only">Current alliance members and stats</caption>
          <thead>
            <tr>
              <th scope="col">Crest</th>
              <th scope="col">Name</th>
              <th scope="col">Rank</th>
              <th scope="col">Role</th>
              <th scope="col">Status</th>
              <th scope="col">Contribution</th>
              <th scope="col">Economy</th>
              <th scope="col">Military</th>
              <th scope="col">Diplomacy</th>
              <th scope="col">Output</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="members-list" aria-live="polite">
            <tr><td colspan="11">Loading members...</td></tr>
          </tbody>
        </table>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">More</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>
</body>

</html>
