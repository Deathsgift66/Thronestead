<!-- Project Name: Thronestead¬© -->
<!-- File Name: alliance_members.html -->
<!-- Version: 7/1/2025 -->
<!-- Developer: Deathsgift66 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alliance Members | Thronestead</title>
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/alliance_members.css" rel="stylesheet" />
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
  <script type="module">
    import { supabase } from '/Javascript/supabaseClient.js';
    import { escapeHTML, showToast, toggleLoading, debounce } from '/Javascript/utils.js';

    const RANK_TOOLTIPS = {
      Leader: 'Alliance leader with full authority',
      'Co-Leader': 'Second in command',
      'War Officer': 'Manages wartime efforts',
      Diplomat: 'Handles treaties and diplomacy',
      Member: 'Standard member'
    };

    const rankPower = ['Member', 'Diplomat', 'War Officer', 'Co-Leader', 'Leader'];
    const rankPowerNormalized = rankPower.map(r => r.toLowerCase());
    let members = [];
    let membersChannel = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!(await enforceAllianceOrAdminAccess())) return;
      const sortBy = document.getElementById('sort-by')?.value || 'username';
      const direction = document.getElementById('sort-direction')?.value || 'asc';
      await fetchMembers(sortBy, direction);
      setupUIControls();
      setupRealtime();
    });

    async function enforceAllianceOrAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return redirectToLogin();
        const [admin, alliance] = await Promise.all([
          supabase.from('users').select('is_admin').eq('user_id', user.id).single(),
          supabase.from('alliance_members').select('user_id').eq('user_id', user.id).maybeSingle()
        ]);
        if (admin.data?.is_admin || alliance.data) return true;
        showToast('You must be in an alliance or be an admin to access this page.', 'error');
        window.location.href = 'overview.html';
        return false;
      } catch (err) {
        console.error('‚ùå Access check error:', err);
        window.location.href = 'overview.html';
        return false;
      }
    }

    function redirectToLogin() {
      window.location.href = 'login.html';
      return false;
    }

    async function fetchMembers(sortBy = 'username', direction = 'asc', search = '') {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="11"><div class="loading-spinner"></div></td></tr>`;
      toggleLoading(true);
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const url = new URL('/api/alliance/members', window.location.origin);
        url.searchParams.set('sort_by', sortBy);
        url.searchParams.set('direction', direction);
        if (search) url.searchParams.set('search', search);
        const res = await fetch(url, { headers: { 'X-User-ID': user.id } });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        members = await res.json();
        renderMembers(members);
      } catch (err) {
        console.error('‚ùå Member fetch error:', err);
        tbody.innerHTML = `<tr><td colspan="11">Failed to load members.</td></tr>`;
      } finally {
        toggleLoading(false);
      }
    }

    function setupUIControls() {
      const btn = document.getElementById('apply-sort');
      if (!btn) return;
      const handler = debounce(async () => {
        btn.disabled = true;
        const original = btn.textContent;
        btn.innerHTML = '<div class="loading-spinner"></div>';
        const keyword = document.getElementById('member-search')?.value.toLowerCase() || '';
        const sortBy = document.getElementById('sort-by')?.value || 'username';
        const direction = document.getElementById('sort-direction')?.value || 'asc';
        await fetchMembers(sortBy, direction, keyword);
        btn.disabled = false;
        btn.textContent = original;
      }, 300);
      btn.addEventListener('click', handler);
    }

    function setupRealtime() {
      membersChannel = supabase
        .channel('public:alliance_members')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'alliance_members'
        }, async () => await fetchMembers())
        .subscribe();

      window.addEventListener('beforeunload', async () => {
        if (membersChannel) {
          await supabase.removeChannel(membersChannel);
          membersChannel = null;
        }
      });
    }

    async function renderMembers(data) {
      const tbody = document.getElementById('members-list');
      if (!tbody) return;
      tbody.innerHTML = '';
      const { isAdmin, userRank, userId } = await getUserPrivileges();
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="empty-state">No matching members found.</td></tr>`;
        return;
      }

      const rankLevel = r => rankPowerNormalized.indexOf((r || 'member').toLowerCase());
      data.forEach(member => {
        const row = document.createElement('tr');
        if (member.rank === 'Leader') row.classList.add('leader-row');
        const canManage = isAdmin || rankLevel(userRank) > rankLevel(member.rank);
        const showFull = member.same_alliance;
        row.innerHTML = `
          <td><img src="/assets/crests/${escapeHTML(member.crest || 'default.png')}" class="crest-icon" alt="Crest" onerror="this.src='/assets/crests/default.png'"></td>
          <td><a href="kingdom_profile.html?kingdom_id=${member.kingdom_id}">${escapeHTML(member.username)}</a>${member.is_vip ? ' ‚≠ê' : ''}</td>
          <td title="${escapeHTML(RANK_TOOLTIPS[member.rank] || '')}">${escapeHTML(member.rank)}</td>
          <td>${showFull ? roleBadge(member) : '‚Äî'}</td>
          <td>${showFull ? escapeHTML(member.status) : '‚Äî'}</td>
          <td>${showFull ? member.contribution : '‚Äî'}</td>
          <td>${showFull ? member.economy_score : '‚Äî'}</td>
          <td>${showFull ? member.military_score : '‚Äî'}</td>
          <td>${showFull ? member.diplomacy_score : '‚Äî'}</td>
          <td>${showFull ? member.total_output : '‚Äî'}</td>
          <td>${canManage ? renderActions(member, userRank.toLowerCase(), userId) : '‚Äî'}</td>
        `;
        tbody.appendChild(row);
      });

      tbody.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const userId = btn.dataset.id;
        if (btn.classList.contains('promote-btn')) promoteMember(userId);
        else if (btn.classList.contains('demote-btn')) demoteMember(userId);
        else if (btn.classList.contains('kick-btn')) removeMember(userId);
        else if (btn.classList.contains('transfer-btn')) transferLeadership(userId);
      });
    }

    async function getUserPrivileges() {
      const { data: { user } } = await supabase.auth.getUser();
      const [admin, rank] = await Promise.all([
        supabase.from('users').select('is_admin').eq('user_id', user.id).single(),
        supabase.from('alliance_members').select('rank').eq('user_id', user.id).maybeSingle()
      ]);
      return {
        isAdmin: admin.data?.is_admin || false,
        userRank: rank.data?.rank || '',
        userId: user.id
      };
    }

    function renderActions(member, currentRole, currentUserId) {
      const actions = [];
      if (member.user_id === currentUserId) return '';
      if (currentRole === 'leader') {
        if (member.rank.toLowerCase() !== 'leader') {
          actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
          actions.push(`<button data-id="${member.user_id}" class="demote-btn">Demote</button>`);
          actions.push(`<button data-id="${member.user_id}" class="kick-btn danger-btn">Kick</button>`);
          actions.push(`<button data-id="${member.user_id}" class="transfer-btn">Transfer Leadership</button>`);
        }
      } else if (currentRole === 'war officer' && member.rank.toLowerCase() === 'member') {
        actions.push(`<button data-id="${member.user_id}" class="promote-btn">Promote</button>`);
        actions.push(`<button data-id="${member.user_id}" class="kick-btn">Kick</button>`);
      }
      return actions.join(' ');
    }

    function roleBadge(member) {
      const cls = (member.rank || '').toLowerCase().replace(/\s+/g, '-');
      const icons = { leader: 'üëë', officer: 'üõ°' };
      const icon = icons[cls] || '';
      const label = member.role || member.rank || '';
      return `<span class="badge role-badge ${cls}">${icon ? icon + ' ' : ''}${escapeHTML(label)}</span>`;
    }

    async function confirmAndPost(endpoint, payload, successMsg, hardConfirm = false) {
      const confirmed = confirm(hardConfirm ? 'Are you sure? This cannot be undone.' : 'Are you sure you want to proceed?');
      if (!confirmed) return;
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-User-ID': user.id },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        showToast(`‚úÖ ${successMsg}`, 'success');
        fetchMembers();
      } catch (err) {
        console.error('‚ùå Action failed:', err);
        showToast(`‚ùå Failed: ${err.message}`, 'error');
      }
    }

    const promoteMember = id => confirmAndPost('/api/alliance_members/promote', { user_id: id }, 'Member promoted.');
    const demoteMember = id => confirmAndPost('/api/alliance_members/demote', { user_id: id }, 'Member demoted.');
    const removeMember = id => confirmAndPost('/api/alliance_members/remove', { user_id: id }, 'Member removed.', true);
    const transferLeadership = id => confirmAndPost('/api/alliance_members/transfer_leadership', { new_leader_id: id }, 'Leadership transferred.');
  </script>
</head>
<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.</div>
  </noscript>

  <div id="navbar-container"></div>
  <div id="resource-bar-container"></div>

  <main>
    <!-- Sorting & Table structure here -->
    <table class="members-table">
      <thead>...header columns...</thead>
      <tbody id="members-list" aria-live="polite">
        <tr><td colspan="11"><div class="loading-spinner"></div></td></tr>
      </tbody>
    </table>
  </main>

  <div id="toast" class="toast-notification" role="status" aria-live="polite"></div>
  <div id="loading-overlay" aria-hidden="true"><div class="spinner"></div></div>

  <footer class="site-footer">
    <div>¬© 2025 Thronestead</div>
    <div><a href="legal.html" target="_blank">Legal</a> <a href="sitemap.xml" target="_blank">Sitemap</a></div>
  </footer>
</body>
</html>
