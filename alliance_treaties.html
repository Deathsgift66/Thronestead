<!--
Project Name: Thronestead©
File Name: alliance_treaties.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alliance Treaties | Thronestead</title>

  <!-- Metadata -->
  <meta name="description" content="Manage and negotiate treaties between alliances in Thronestead." />
  <meta name="keywords" content="Thronestead, alliance treaties, diplomacy, negotiations" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.thronestead.com/alliance_treaties.html" />

  <!-- Open Graph & Twitter -->
  <meta property="og:title" content="Alliance Treaties | Thronestead" />
  <meta property="og:description" content="Diplomacy center for proposing and managing alliance treaties in Thronestead." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="alliance_treaties.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alliance Treaties | Thronestead" />
  <meta name="twitter:description" content="Negotiate and manage alliance treaties in Thronestead." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- Styles -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/progressionBanner.css" rel="stylesheet" />
  <link href="/CSS/alliance_treaties.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet" />

  <!-- JS Modules -->
  <script src="/Javascript/allianceAppearance.js" type="module"></script>
  <script src="/Javascript/progressionBanner.js" type="module"></script>
  <script type="module">
    import { escapeHTML, openModal, closeModal } from '/Javascript/utils.js';

    // -------------------- Initialization --------------------
    document.addEventListener('DOMContentLoaded', () => {
      loadTreaties();
      document
        .getElementById('create-new-treaty')
        ?.addEventListener('click', proposeTreaty);
      document
        .querySelector('.modal-close')
        ?.addEventListener('click', () => closeModal('treaty-modal'));
      document.getElementById('treaty-modal')?.addEventListener('click', e => {
        if (e.target.id === 'treaty-modal') closeModal('treaty-modal');
      });
    });

    // -------------------- Treaty Feed --------------------
    async function loadTreaties() {
      const container = document.getElementById('treaties-container');
      container.innerHTML = '<p>Loading treaties...</p>';
      try {
        const res = await fetch('/api/alliance/treaties');
        const treaties = await res.json();
        if (!treaties.length) {
          container.innerHTML = "<p class='empty-state'>No treaties found.</p>";
          return;
        }
        container.innerHTML = treaties.map(t => renderTreatyCard(t)).join('');
        bindCardActions();
      } catch (err) {
        console.error('Failed to load treaties:', err);
        container.innerHTML = '<p>Failed to load treaties.</p>';
      }
    }

    function renderTreatyCard(t) {
      const type = (t.type || t.treaty_type || '')
        .replaceAll('_', ' ')
        .toUpperCase();
      return `
        <div class="treaty-card ${t.status}">
          <h3>${escapeHTML(type)}</h3>
          <p><strong>With:</strong> ${escapeHTML(t.partner_name)}</p>
          <p><strong>Status:</strong> ${escapeHTML(t.status)}</p>
          ${
            t.status === 'proposed'
              ? "<button class='respond-btn' data-id='" + t.treaty_id + "'>Respond</button>"
              : ''
          }
          <button class="view-btn" data-id="${t.treaty_id}">View</button>
        </div>
      `;
    }

    function bindCardActions() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => openTreatyModal(btn.dataset.id));
      });
      document.querySelectorAll('.respond-btn').forEach(btn => {
        btn.addEventListener('click', () => openTreatyModal(btn.dataset.id));
      });
    }

    // -------------------- Modal --------------------
    function openTreatyModal(id) {
      fetch(`/api/alliance/treaty/${id}`)
        .then(res => res.json())
        .then(t => {
          const box = document.getElementById('treaty-details');
          const termsRows = Object.entries(t.terms || {})
            .map(
              ([k, v]) =>
                `<tr><th>${escapeHTML(k)}</th><td>${escapeHTML(String(v))}</td></tr>`
            )
            .join('');
          box.innerHTML = '';
          box.innerHTML = `
            <h3>${escapeHTML(t.name)}</h3>
            <p>Partner: ${escapeHTML(t.partner_name)}</p>
            <p>Status: ${escapeHTML(t.status)}</p>
            <table class="terms-table"><tbody>${termsRows}</tbody></table>
            ${
              t.status === 'proposed'
                ? `
          <button class="accept-btn" data-id="${t.id}">Accept</button>
          <button class="reject-btn" data-id="${t.id}">Reject</button>
        `
                : ''
            }
          `;
          openModal('treaty-modal');
          document
            .querySelector('.accept-btn')
            ?.addEventListener('click', () => respondToTreaty(t.id, 'accept'));
          document
            .querySelector('.reject-btn')
            ?.addEventListener('click', () => respondToTreaty(t.id, 'reject'));
        })
        .catch(err => console.error('Failed to load treaty:', err));
    }

    // -------------------- Actions --------------------
    async function respondToTreaty(id, response) {
      try {
        await fetch('/api/alliance/treaties/respond', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ treaty_id: parseInt(id, 10), response })
        });
        closeModal('treaty-modal');
        loadTreaties();
      } catch (err) {
        console.error('Failed to respond:', err);
      }
    }

    async function proposeTreaty() {
      const type = prompt(
        'Enter treaty type (non_aggression_pact, defensive_pact, trade_pact, intelligence_sharing, research_collaboration):'
      );
      const partnerId = prompt('Enter partner alliance ID:');
      if (!type || !partnerId) return;
      try {
        await fetch('/api/alliance/treaties/propose', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            partner_alliance_id: parseInt(partnerId, 10),
            treaty_type: type,
            terms: { duration_days: 30, exclusive: true }
          })
        });
        loadTreaties();
      } catch (err) {
        console.error('Failed to propose treaty:', err);
      }
    }
  </script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>

  <!-- Navbar -->

  <!-- Banner -->
  <header class="kr-top-banner" aria-label="Alliance Treaties Page Header">
    Alliance Treaties
  </header>

  <!-- Main Diplomacy Panel -->
  <main class="main-centered-container" aria-label="Alliance Treaty Management">
    <section class="alliance-members-container">
      <!-- Visual ID -->
      <div class="alliance-visuals">
        <img class="alliance-banner" src="Assets/banner.png" alt="Alliance Banner" />
        <img class="alliance-emblem" src="Assets/avatars/default_avatar_emperor.png" alt="Alliance Emblem" />
      </div>

      <h2>Diplomatic Relations</h2>
      <p>Track active treaties, propose new agreements, and manage diplomatic relations with other alliances.</p>

      <!-- Create Treaty -->
      <button id="create-new-treaty" class="action-btn" aria-label="Propose New Treaty">
        New Proposal
      </button>

      <!-- Treaty Feed -->
      <div id="treaties-container" aria-live="polite" aria-label="Treaty Status Feed">
        <!-- JS injects treaty cards here -->
      </div>
    </section>
  </main>

  <!-- Treaty Modal -->
  <div id="treaty-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
    <div class="modal-content">
      <button class="modal-close" aria-label="Close treaty details">&times;</button>
      <div id="treaty-details" aria-live="polite">
        <!-- JS injects treaty detail view -->
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">More</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>

</body>

</html>
