<!--
Project Name: Thronestead©
File Name: alliance_home.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Alliance Home | Thronestead</title>

  <!-- Metadata -->
  <meta name="description" content="Alliance command center: view members, progress, projects, and stats." />
  <meta name="keywords" content="Thronestead, Alliance Hub, projects, members, command center, medieval MMO" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.thronestead.com/alliance_home.html" />

  <!-- Open Graph -->
  <meta property="og:title" content="Alliance Home | Thronestead" />
  <meta property="og:description" content="Manage your alliance's members, projects, and defenses." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="alliance_home.html" />
  <meta property="og:type" content="website" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alliance Home | Thronestead" />
  <meta name="twitter:description" content="Manage your alliance's members, projects, and defenses." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- CSS -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/alliance_common.css" rel="stylesheet" />
  <link href="/CSS/alliance_home.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet" />

  <!-- JS -->
  <script type="module">
    // Project Name: Thronestead©
    // File Name: alliance_home.js
    // Version:  7/1/2025 10:38
    // Developer: Deathsgift66

    import { supabase } from '/Javascript/supabaseClient.js';
    import { escapeHTML, setText, formatDate, fragmentFrom, jsonFetch } from '/Javascript/utils.js';

    let activityChannel = null;

    window.addEventListener('beforeunload', () => {
      if (activityChannel) supabase.removeChannel(activityChannel);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } = {} } = await supabase.auth.getSession();
      const userId = session?.user?.id;
      if (!userId) {
        window.location.href = 'login.html';
        return;
      }
      fetchAllianceDetails(userId);
    });

    async function fetchAllianceDetails(userId) {
      try {
        const data = await jsonFetch('/api/alliance-home/details', {
          headers: { 'X-User-ID': userId }
        });
        populateAlliance(data);
        setupRealtime(data.alliance?.alliance_id);
      } catch (err) {
        console.error('❌ Failed to fetch alliance details:', err);
      }
    }

    function populateAlliance(data) {
      const a = data.alliance;
      if (!a) return;

      const safe = v => v ?? 0;

      setText('alliance-name', a.name);
      setText('alliance-leader', a.leader);
      setText('alliance-region', a.region);
      setText('alliance-founded', formatDate(a.created_at));
      setText('alliance-level', a.level);
      setText('alliance-status', a.status);
      setText('alliance-members', a.member_count);
      setText('alliance-wars-count', a.wars_count);
      setText('alliance-treaties-count', a.treaties_count);
      setText('alliance-military', a.military_score);
      setText('alliance-economy', a.economy_score);
      setText('alliance-diplomacy', a.diplomacy_score);

      const banner = document.getElementById('alliance-banner-img');
      if (banner) {
        banner.src = a.banner || '/Assets/banner.png';
        banner.alt = `Banner of ${a.name}`;
      }

      const emblem = document.getElementById('alliance-emblem-img');
      if (emblem && a.emblem_url) {
        emblem.src = a.emblem_url;
        emblem.alt = `Emblem of ${a.name}`;
      }

      if (data.vault) {
        setText('alliance-fortification', safe(data.vault.fortification_level));
        setText('alliance-army', safe(data.vault.army_count));
        setText('vault-gold', safe(data.vault.gold));
        setText('vault-food', safe(data.vault.food));
        setText('vault-ore', safe(data.vault.iron_ore));
      }

      renderProjects(data.projects);
      renderMembers(data.members);
      renderTopContributors(data.members);
      renderQuests(data.quests);
      renderAchievements(data.achievements);
      renderActivity(data.activity);
      renderDiplomacy(data.treaties);
      renderActiveBattles(data.wars);
      renderWarScore(data.wars);
    }

    // === Render Utilities ===

    function setFallbackText(el, message, tag = 'p') {
      el.innerHTML = `<${tag} class="empty">${message}</${tag}>`;
    }

    function renderProjects(projects = []) {
      const container = document.getElementById('project-progress-bars');
      if (!container) return;
      if (!projects.length) return setFallbackText(container, 'No active projects.');
      const frag = fragmentFrom(projects, p => {
        const div = document.createElement('div');
        div.className = 'progress-bar';
        div.innerHTML = `<label>${escapeHTML(p.name)}</label><progress value="${p.progress}" max="100"></progress><span>${p.progress}%</span>`;
        return div;
      });
      container.replaceChildren(frag);
    }

    function renderMembers(members = []) {
      const body = document.getElementById('members-list');
      if (!body) return;
      if (!members.length) return setFallbackText(body, 'No members.', 'tr');

      const top = Math.max(0, ...members.map(m => m.contribution || 0));
      const frag = fragmentFrom(members, m => {
        const row = document.createElement('tr');
        let icons = '';
        if (m.rank === 'Leader') icons += '👑 ';
        else if (m.rank === 'Officer') icons += '🛡️ ';
        if ((m.contribution || 0) === top && top > 0) icons += '🔥 ';
        row.innerHTML = `
      <td>${icons}<img src="../assets/crests/${escapeHTML(m.crest || 'default.png')}" alt="Crest of ${escapeHTML(m.username)}" class="crest"></td>
      <td>${escapeHTML(m.username)}</td>
      <td>${escapeHTML(m.rank)}</td>
      <td>${m.contribution ?? 0}</td>
      <td>${escapeHTML(m.status)}</td>`;
        return row;
      });
      body.replaceChildren(frag);
    }

    function renderTopContributors(members = []) {
      const list = document.getElementById('top-contrib-list');
      if (!list) return;
      list.innerHTML = '';

      if (!members.length) return setFallbackText(list, 'No contributors yet.');

      members
        .sort((a, b) => (b.contribution || 0) - (a.contribution || 0))
        .slice(0, 5)
        .forEach(m => {
          const li = document.createElement('li');
          li.className = 'top-contrib-entry';
          li.innerHTML = `
        <img class="contrib-avatar" src="${m.avatar || '/Assets/avatars/default_avatar_emperor.png'}" alt="${escapeHTML(m.username)}">
        <span> ${escapeHTML(m.username)} - ${m.contribution}</span>`;
          list.appendChild(li);
        });
    }

    function renderQuests(quests = []) {
      const container = document.getElementById('quest-list');
      if (!container) return;
      if (!quests.length) return setFallbackText(container, 'No active quests.');

      const frag = fragmentFrom(quests, q => {
        const div = document.createElement('div');
        div.className = 'quest-card';
        div.innerHTML = `<strong>${escapeHTML(q.name)}</strong><div class="quest-progress-bar"><div class="quest-progress-fill" data-width="${q.progress}"></div></div>`;
        return div;
      });
      container.replaceChildren(frag);
    }

    function renderAchievements(achievements = []) {
      const list = document.getElementById('achievements-list');
      if (!list) return;
      if (!achievements.length) return setFallbackText(list, 'No achievements earned yet.');

      const frag = fragmentFrom(achievements, a => {
        const li = document.createElement('li');
        const badge = document.createElement('span');
        badge.className = 'achievement-badge';
        if (a.badge_icon_url) badge.style.backgroundImage = `url(${a.badge_icon_url})`;
        li.appendChild(badge);
        li.insertAdjacentText('beforeend', ` ${a.name}`);
        return li;
      });
      list.replaceChildren(frag);
    }

    function renderActivity(entries = []) {
      const list = document.getElementById('activity-log');
      if (!list) return;
      if (!entries.length) return setFallbackText(list, 'No recent activity.');

      const frag = fragmentFrom(entries, e => {
        const li = document.createElement('li');
        li.className = 'activity-log-entry';
        li.textContent = `[${formatDate(e.created_at)}] ${e.username}: ${e.description}`;
        return li;
      });
      list.replaceChildren(frag);
    }

    function renderDiplomacy(treaties = []) {
      const container = document.getElementById('diplomacy-table');
      if (!container) return;
      if (!treaties.length) return setFallbackText(container, 'No treaties.');
      const frag = fragmentFrom(treaties, t => {
        const div = document.createElement('div');
        div.className = 'diplomacy-row';
        div.textContent = `${t.treaty_type} with Alliance ${t.partner_alliance_id} (${t.status})`;
        return div;
      });
      container.replaceChildren(frag);
    }

    function renderActiveBattles(wars = []) {
      const container = document.getElementById('active-battles-list');
      if (!container) return;

      const active = wars.filter(w => w.war_status === 'active');
      if (!active.length) return setFallbackText(container, 'No active battles.');

      const frag = fragmentFrom(active, w => {
        const div = document.createElement('div');
        div.className = 'battle-entry';
        div.textContent = `War ${w.alliance_war_id} — ${w.war_status}`;
        return div;
      });
      container.replaceChildren(frag);
    }

    function renderWarScore(wars = []) {
      const container = document.getElementById('war-score-summary');
      if (!container) return;
      if (!wars.length) return setFallbackText(container, 'No war scores.');

      const frag = fragmentFrom(wars, w => {
        const div = document.createElement('div');
        const att = w.attacker_score ?? 0;
        const def = w.defender_score ?? 0;
        div.textContent = `War ${w.alliance_war_id}: Attacker ${att} vs Defender ${def}`;
        return div;
      });
      container.replaceChildren(frag);
    }

    // === Realtime Handling ===

    function setupRealtime(allianceId) {
      if (!allianceId) return;
      if (activityChannel) supabase.removeChannel(activityChannel);

      activityChannel = supabase
        .channel(`alliance_home_${allianceId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'alliance_activity_log',
          filter: `alliance_id=eq.${allianceId}`
        }, payload => addActivityEntry(payload.new))
        .subscribe()
        .catch(err => console.error('Failed to setup realtime channel:', err));
    }

    function addActivityEntry(entry) {
      const list = document.getElementById('activity-log');
      if (!list) return;

      const li = document.createElement('li');
      li.className = 'activity-log-entry';
      li.textContent = `[${formatDate(entry.created_at)}] ${entry.user_id}: ${entry.description}`;
      list.prepend(li);

      if (list.children.length > 20) list.removeChild(list.lastChild);
    }
  </script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body class="alliance-bg">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navbar -->

  <!-- Header -->
  <header class="kr-top-banner" aria-label="Alliance Homepage Banner">
    Thronestead – Alliance Command Center
  </header>

  <!-- Main Content -->
  <main class="alliance-home-container" aria-label="Alliance Dashboard">
    <!-- Overview -->
    <section class="panel alliance-details" aria-labelledby="overview-heading">
      <h2 id="overview-heading">Alliance Overview</h2>
      <div class="alliance-visuals">
        <img id="alliance-emblem-img" src="Assets/avatars/default_avatar_emperor.png" alt="Emblem of Alliance" />
        <img id="alliance-banner-img" src="Assets/banner.png" alt="Banner of Alliance" />
      </div>
      <p><strong>Name:</strong> <span id="alliance-name">Loading...</span></p>
      <p><strong>Leader:</strong> <span id="alliance-leader">Loading...</span></p>
      <p><strong>Region:</strong> <span id="alliance-region">Loading...</span></p>
      <p><strong>Founded:</strong> <span id="alliance-founded">Loading...</span></p>
      <p><strong>Level:</strong> <span id="alliance-level">Loading...</span></p>
      <p><strong>Members:</strong> <span id="alliance-members">Loading...</span></p>
      <p><strong>Status:</strong> <span id="alliance-status">Loading...</span></p>
      <p><strong>Wars:</strong> <span id="alliance-wars-count">0</span></p>
      <p><strong>Treaties:</strong> <span id="alliance-treaties-count">0</span></p>
    </section>

    <!-- Stats -->
    <section class="panel alliance-stats" aria-labelledby="stats-heading">
      <h2 id="stats-heading">Alliance Stats</h2>
      <p><strong>Military Score:</strong> <span id="alliance-military">0</span></p>
      <p><strong>Economy Score:</strong> <span id="alliance-economy">0</span></p>
      <p><strong>Diplomacy Score:</strong> <span id="alliance-diplomacy">0</span></p>
      <p><strong>Fortification Level:</strong> <span id="alliance-fortification">0</span></p>
      <p><strong>Total Donated Army:</strong> <span id="alliance-army">0</span></p>
    </section>

    <!-- Vault -->
    <section class="panel vault-snapshot" aria-labelledby="vault-heading">
      <h2 id="vault-heading">Vault Snapshot</h2>
      <p><strong>Gold:</strong> <span id="vault-gold">0</span></p>
      <p><strong>Food:</strong> <span id="vault-food">0</span></p>
      <p><strong>Ore:</strong> <span id="vault-ore">0</span></p>
    </section>

    <!-- Contributors -->
    <section class="panel top-contributors" aria-labelledby="top-contrib-heading">
      <h2 id="top-contrib-heading">Top Contributors</h2>
      <ul id="top-contrib-list">
        <li>Loading...</li>
      </ul>
    </section>

    <!-- Projects -->
    <section class="panel alliance-projects" aria-labelledby="projects-heading">
      <h2 id="projects-heading">Active Projects</h2>
      <div id="project-progress-bars" class="progress-container"></div>
    </section>

    <!-- Members -->
    <section class="panel alliance-members" aria-labelledby="members-heading">
      <h2 id="members-heading">Alliance Members</h2>
      <table class="members-table">
        <thead>
          <tr>
            <th scope="col">Crest</th>
            <th scope="col">Name</th>
            <th scope="col">Rank</th>
            <th scope="col">Contribution</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody id="members-list"></tbody>
      </table>
      <button id="load-more-members" class="load-more">Load More</button>
    </section>

    <!-- Achievements -->
    <section class="panel alliance-achievements" aria-labelledby="achievements-heading">
      <h2 id="achievements-heading">Alliance Achievements</h2>
      <ul id="achievements-list">
        <li>Loading achievements...</li>
      </ul>
    </section>

    <!-- Quests -->
    <section class="panel alliance-quests" aria-labelledby="quests-heading">
      <h2 id="quests-heading">Quest Progress</h2>
      <div id="quest-list"></div>
    </section>

    <!-- Active Battles -->
    <section class="panel active-battles" aria-labelledby="active-battles-heading">
      <h2 id="active-battles-heading">Active Battles</h2>
      <div id="active-battles-list"></div>
      <button id="load-more-wars" class="load-more">Load More</button>
    </section>

    <!-- War Score -->
    <section class="panel war-score" aria-labelledby="war-score-heading">
      <h2 id="war-score-heading">War Score</h2>
      <div id="war-score-summary"></div>
    </section>

    <!-- Diplomacy -->
    <section class="panel diplomacy-overview" aria-labelledby="diplomacy-heading">
      <h2 id="diplomacy-heading">Diplomacy Overview</h2>
      <div id="diplomacy-table"></div>
    </section>

    <!-- Activity Log -->
    <section class="panel activity-log" aria-labelledby="activity-heading">
      <h2 id="activity-heading">Recent Activity Log</h2>
      <ul id="activity-log"></ul>
      <button id="load-more-activity" class="load-more">Load More</button>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">Legal</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>
</body>

</html>
