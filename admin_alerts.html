<!--
Project Name: Thronestead©
File Name: admin_alerts.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Admin Alerts | Thronestead</title>

  <!-- SEO -->
  <meta name="description" content="Admin alert center for account monitoring and moderation." />
  <meta name="keywords" content="Thronestead, Admin Alerts, moderation, flagged accounts, security, RPG" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="canonical" href="https://www.thronestead.com/admin_alerts.html" />

  <!-- Open Graph -->
  <meta property="og:title" content="Admin Alerts | Thronestead" />
  <meta property="og:description" content="Monitor flagged accounts, suspicious behavior, and enforce realm-wide security policies." />
  <meta property="og:image" content="https://www.thronestead.com/Assets/banner_main.png" />
  <meta property="og:url" content="https://www.thronestead.com/admin_alerts.html" />
  <meta property="og:type" content="website" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Admin Alerts | Thronestead" />
  <meta name="twitter:description" content="Monitor and enforce account security from the Thronestead Admin Center." />
  <meta name="twitter:image" content="https://www.thronestead.com/Assets/banner_main.png" />

  <!-- Global Assets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/admin_alerts.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet" />

  <!-- Admin Scripts -->
  <script type="module">
    window.requireAdmin = true;
  </script>
  <script type="module">
    import { supabase } from '/Javascript/supabaseClient.js';
    import { authJsonFetch, showToast } from '/Javascript/utils.js';
    import { setupReauthButtons } from '/Javascript/reauth.js';
    import { validateSessionOrLogout } from '/Javascript/auth.js';

    const REFRESH_MS = 30000;
    const AUTO_EXPIRE_MS = 60000;
    const MAX_FEED_ITEMS = 250;
    let realtimeSub = null;
    let currentData = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadAlerts();
      setInterval(loadAlerts, REFRESH_MS);
      subscribeToRealtime();
      document.getElementById('refresh-alerts')?.addEventListener('click', loadAlerts);
      document.getElementById('clear-filters')?.addEventListener('click', clearFilters);
      document.getElementById('export-csv')?.addEventListener('click', exportCSV);
      document.getElementById('export-json')?.addEventListener('click', exportJSON);
      document.querySelectorAll('.alert-tabs .tab').forEach(tab =>
        tab.addEventListener('click', () => selectTab(tab))
      );
      document.getElementById('alerts-feed')?.addEventListener('click', handleActionClick);
      initThemeToggle();
      setupReauthButtons('.action-btn');
      supabase.auth.onAuthStateChange((_evt, session) => {
        if (!session) validateSessionOrLogout();
      });
    });

    window.addEventListener('beforeunload', async () => {
      if (realtimeSub) await supabase.removeChannel(realtimeSub);
    });

    function subscribeToRealtime() {
      realtimeSub = supabase
        .channel('admin_alerts')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'admin_alerts' }, loadAlerts)
        .subscribe();
    }

    async function loadAlerts() {
      const container = document.getElementById('alerts-feed');
      if (!container) return;
      container.innerHTML = '<p>Loading alerts...</p>';

      try {
        const data = await authJsonFetch('/api/admin/alerts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(getFilters())
        });
        currentData = data;

        container.innerHTML = '';

        const renderSet = Array.isArray(data.alerts)
          ? [{ title: 'Alerts', items: data.alerts }]
          : [
              { title: 'Moderation', items: data.moderation_notes },
              { title: 'War', items: data.recent_war_logs },
              { title: 'Diplomacy', items: data.treaty_activity },
              { title: 'Audit Log', items: data.audit },
              { title: 'Admin Actions', items: data.admin_actions }
            ];

        if (!renderSet.some(s => (s.items || []).length)) {
          container.innerHTML = '<p>No alerts found.</p>';
          return;
        }

        let remaining = MAX_FEED_ITEMS;
        renderSet.forEach(set => {
          if (!remaining) {
            set.items = [];
            return;
          }
          set.items = (set.items || []).slice(0, remaining);
          remaining -= set.items.length;
        });
        if (remaining <= 0) {
          showToast('⚠ Only first 250 alerts shown. Refine filters.', 'warning');
        }

        renderSet.forEach(({ title, items }) => renderCategory(container, title, items));
      } catch (err) {
        console.error('❌ Failed to load alerts:', err);
        container.innerHTML = '<p>Error loading alerts. Please try again later.</p>';
      }
    }

    function renderCategory(container, title, items = []) {
      if (!items.length) return;

      const section = document.createElement('div');
      section.className = 'alert-category';

      const header = document.createElement('h3');
      header.textContent = title;
      section.appendChild(header);

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = `alert-item ${mapSeverity(item.severity || item.priority)}`;
        div.setAttribute('role', 'article');
        const evType = escapeHTML((item.event_type || item.type || 'log').toUpperCase());
        div.innerHTML = `
      <strong>[${evType}]</strong>
      <p>${formatItem(item)}</p>
      <small>
         Kingdom: ${escapeHTML(String(item.kingdom_id || '—'))} |
         Alliance: ${escapeHTML(String(item.alliance_id || '—'))} |
         ${item.timestamp ? formatTime(item.timestamp) : '—'}
      </small>
    `;

        const actions = document.createElement('div');
        actions.className = 'action-buttons';
        const actionMap = [
          { action: 'flag', label: 'Flag', data: { player_id: item.player_id } },
          { action: 'freeze', label: 'Freeze', data: { player_id: item.player_id } },
          { action: 'ban', label: 'Ban', data: { player_id: item.player_id } },
          { action: 'dismiss', label: 'Dismiss', data: { alert_id: getAlertId(item) } },
          { action: 'flag_ip', label: 'Flag IP', data: { ip: item.ip } },
          { action: 'suspend_user', label: 'Suspend', data: { user_id: item.user_id } },
          { action: 'mark_alert_handled', label: 'Mark Reviewed', data: { alert_id: getAlertId(item) } }
        ];

        actionMap.forEach(({ action, label, data }) => {
          const hasValidData = Object.values(data).some(v => v !== undefined && v !== null && v !== '');
          if (!hasValidData) return;
          const btn = document.createElement('button');
          btn.className = 'btn btn-small action-btn';
          btn.textContent = label;
          btn.dataset.action = action;
          Object.entries(data).forEach(([k, v]) => (btn.dataset[k] = v));
          actions.appendChild(btn);
        });

        div.appendChild(actions);
        setTimeout(() => div.classList.add('expired'), AUTO_EXPIRE_MS);
        section.appendChild(div);
      });

      container.appendChild(section);
    }

    async function handleActionClick(e) {
      if (!e.target.classList.contains('action-btn')) return;
      const btn = e.target;
      const action = btn.dataset.action;

      const idPattern = /^[0-9a-fA-F-]{8,}$/;
      const ipPattern = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;

      const requiresConfirm = ['ban', 'freeze', 'suspend_user'];
      if (requiresConfirm.includes(action)) {
        const label = btn.textContent || action;
        const confirmed = confirm(`⚠️ Are you sure you want to ${label.toLowerCase()} this user?`);
        if (!confirmed) return;
      }

      try {
        switch (action) {
          case 'flag':
            if (!idPattern.test(btn.dataset.player_id)) throw new Error('Invalid player id');
            await postAdminAction('/api/admin/flag', { player_id: btn.dataset.player_id, alert_id: btn.dataset.alert_id });
            break;
          case 'freeze':
            if (!idPattern.test(btn.dataset.player_id)) throw new Error('Invalid player id');
            await postAdminAction('/api/admin/freeze', { player_id: btn.dataset.player_id, alert_id: btn.dataset.alert_id });
            break;
          case 'ban':
            if (!idPattern.test(btn.dataset.player_id)) throw new Error('Invalid player id');
            await postAdminAction('/api/admin/ban', { player_id: btn.dataset.player_id, alert_id: btn.dataset.alert_id });
            break;
          case 'dismiss':
            if (!idPattern.test(btn.dataset.alert_id)) throw new Error('Invalid alert id');
            await postAdminAction('/api/admin/dismiss_alert', { alert_id: btn.dataset.alert_id });
            break;
          case 'flag_ip':
            if (!ipPattern.test(btn.dataset.ip)) throw new Error('Invalid IP');
            await postAdminAction('/api/admin/flag_ip', { ip: btn.dataset.ip });
            break;
          case 'suspend_user':
            if (!idPattern.test(btn.dataset.user_id)) throw new Error('Invalid user id');
            await postAdminAction('/api/admin/suspend_user', { user_id: btn.dataset.user_id });
            break;
          case 'mark_alert_handled':
            await postAdminAction('/api/admin/mark_alert_handled', { alert_id: btn.dataset.alert_id });
            btn.disabled = true;
            break;
        }

        btn.disabled = true;
        setTimeout(() => (btn.disabled = false), 3000);

        showToast(`✅ ${action.replace(/_/g, ' ')} successful.`, 'success');
        loadAlerts();
      } catch (err) {
        console.error(`❌ Action [${action}] failed:`, err);
        showToast(`❌ ${action} failed: ${err.message}`, 'error');
      }
    }

    async function postAdminAction(endpoint, payload) {
      const { data: { session } } = await supabase.auth.getSession();
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session?.access_token || ''}`,
        'X-User-ID': session?.user?.id || ''
      };
      const res = await fetch(endpoint, {
        method: 'POST',
        credentials: 'include',
        headers,
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
    }

    function getFilters() {
      return Object.fromEntries(
        ['start', 'end', 'type', 'severity', 'kingdom', 'alliance']
          .map(k => [k, document.getElementById(`filter-${k}`)?.value])
          .filter(([, v]) => v)
      );
    }

    function clearFilters() {
      document.querySelectorAll('.filter-input').forEach(el => (el.value = ''));
      loadAlerts();
    }

    function mapSeverity(sev = '') {
      const s = sev.toLowerCase();
      if (s.includes('high') || s.includes('critical')) return 'severity-high';
      if (s.includes('medium')) return 'severity-medium';
      return 'severity-low';
    }

    function escapeHTML(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function formatItem(item) {
      const base = item.message || `${item.action || ''} - ${item.details || item.note || 'No details'}`;
      return escapeHTML(base);
    }

    function formatTime(ts) {
      return ts ? new Date(ts).toLocaleString() : '';
    }


    function getAlertId(item) {
      if (!item.alert_id) {
        if (item.id) {
          console.warn('Missing alert_id, using fallback id:', item.id);
          return item.id;
        }
        console.warn('Missing alert_id and fallback id:', item);
        return '';
      }
      return item.alert_id;
    }

    function exportJSON() {
      if (!currentData) return;
      const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'alerts.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!currentData || !Array.isArray(currentData.alerts)) return;
      const rows = [
        ['type', 'message', 'kingdom', 'alliance', 'timestamp', 'severity']
      ];
      currentData.alerts.forEach(it => {
        rows.push([
          it.event_type || it.type || '',
          (it.message || it.note || '').replace(/"/g, '""'),
          it.kingdom_id || '',
          it.alliance_id || '',
          it.timestamp || '',
          it.severity || it.priority || ''
        ]);
      });
      const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'alerts.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function selectTab(tab) {
      document.querySelectorAll('.alert-tabs .tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const type = tab.dataset.type || '';
      const select = document.getElementById('filter-type');
      if (select) select.value = type;
      const url = new URL(window.location);
      if (type) url.searchParams.set('type', type);
      else url.searchParams.delete('type');
      history.pushState({}, '', url);
      loadAlerts();
    }

    function initThemeToggle() {
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      const saved = localStorage.getItem('theme') || document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', saved);
      btn.textContent = saved === 'dark' ? 'Light Mode' : 'Dark Mode';
      btn.addEventListener('click', () => {
        document.documentElement.classList.add('theme-transition');
        setTimeout(() => {
          document.documentElement.classList.remove('theme-transition');
        }, 300);
        const current = document.body.getAttribute('data-theme') === 'dark' ? 'parchment' : 'dark';
        document.body.setAttribute('data-theme', current);
        localStorage.setItem('theme', current);
        btn.textContent = current === 'dark' ? 'Light Mode' : 'Dark Mode';
      });
    }
  </script>

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body data-theme="parchment">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navbar -->

  <!-- Banner -->
  <header class="kr-top-banner" aria-label="Admin Panel Header">
    Thronestead – Admin Alert Center
  </header>

  <!-- Main Admin Panel -->
  <main class="main-container" aria-label="Admin Alerts Interface">
    <div class="admin-alerts-container">

      <h2>Flagged Accounts & Suspicious Events</h2>
      <div class="alert-tabs" aria-label="Alert Type Tabs">
        <button class="tab active" data-type="">All</button>
        <button class="tab" data-type="moderation">Moderation</button>
        <button class="tab" data-type="war">War</button>
        <button class="tab" data-type="diplomacy">Diplomacy</button>
        <button class="tab" data-type="economy">Economy</button>
      </div>

      <!-- Filters -->
      <section class="search-sort-controls" aria-label="Admin Alert Filters" role="form">
        <input type="datetime-local" id="filter-start" class="filter-input" aria-label="Start Time" />
        <input type="datetime-local" id="filter-end" class="filter-input" aria-label="End Time" />
        
        <select id="filter-type" class="filter-input" aria-label="Alert Type">
          <option value="">All Types</option>
          <option value="moderation">Moderation</option>
          <option value="war">War</option>
          <option value="economy">Economy</option>
          <option value="diplomacy">Diplomacy</option>
          <option value="quests">Quests</option>
          <option value="abuse">Resource Abuse</option>
          <option value="spy">Spy Detection</option>
          <option value="vip">VIP Abuse</option>
        </select>

        <select id="filter-severity" class="filter-input" aria-label="Severity Level">
          <option value="">Any Severity</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>

        <input type="text" id="filter-kingdom" class="filter-input" placeholder="Kingdom ID" aria-label="Filter by Kingdom ID" />
        <input type="text" id="filter-alliance" class="filter-input" placeholder="Alliance ID" aria-label="Filter by Alliance ID" />

        <button id="refresh-alerts" class="btn btn-primary">Refresh</button>
        <button id="clear-filters" class="btn btn-secondary">Clear</button>
        <button id="export-csv" class="btn btn-secondary" type="button">Export CSV</button>
        <button id="export-json" class="btn btn-secondary" type="button">Export JSON</button>
        <button id="theme-toggle" class="btn btn-secondary" type="button">Dark Mode</button>
      </section>

      <!-- Alert Feed Panel -->
      <section class="kr-alerts-panel" aria-label="Live Alert Feed" role="feed">
        <div id="alerts-feed" aria-live="polite" class="alerts-feed">
          <!-- JavaScript inserts real-time alerts here -->
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>© 2025 Thronestead</div>
    <div>
      <a target="_blank" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">Legal</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>
</body>

</html>
