<!--
Project Name: Thronestead©
File Name: spy_mission.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Spy Mission | Thronestead</title>
  <meta name="description" content="Plan and launch covert missions against rival kingdoms in Thronestead." />
  <meta name="keywords" content="Thronestead, spy mission, espionage, covert operations" />
  <meta property="og:title" content="Spy Mission | Thronestead" />
  <meta property="og:description" content="Plan and launch covert missions against rival kingdoms in Thronestead." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="spy_mission.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Spy Mission | Thronestead" />
  <meta name="twitter:description" content="Plan and launch covert missions against rival kingdoms in Thronestead." />
  <meta name="twitter:image" content="Assets/banner_main.png" />
  <link rel="canonical" href="https://www.thronestead.com/spy_mission.html" />
  <meta name="theme-color" content="#2e2b27" />

  <!-- Page-Specific Assets -->
  <link href="/CSS/spy_mission.css" rel="stylesheet" />

  <!-- Global Assets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />

<!-- ✅ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>
<body>
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>
  <!-- Navbar -->

  <!-- Page Banner -->
  <header class="kr-top-banner" aria-label="Spy Mission Banner">
    Thronestead — Spy Mission
  </header>

  <!-- Main Content -->
  <main class="main-centered-container" aria-label="Spy Mission Interface">
    <section class="mission-panel" aria-labelledby="mission-heading">
      <h2 id="mission-heading">Launch Spy Mission</h2>
      <form id="launch-form">
        <label for="target-kingdom">Target Kingdom</label>
        <input id="target-kingdom" list="kingdom-list" autocomplete="off" required />
        <datalist id="kingdom-list"></datalist>

        <label for="mission-type">Mission Type</label>
        <select id="mission-type">
          <option value="spy_troops">Spy Troops</option>
          <option value="spy_resources">Spy Resources</option>
          <option value="assassinate_spies">Assassinate Spies</option>
          <option value="assassinate_noble">Assassinate Noble</option>
          <option value="assassinate_knight">Assassinate Knight</option>
        </select>

        <label for="spy-count">Number of Spies</label>
        <input type="number" id="spy-count" min="1" required />

        <div id="success-rate" aria-live="polite"></div>

        <button type="submit" class="btn-fantasy">Confirm Mission</button>
      </form>
      <div id="mission-results" class="mission-results" aria-live="polite"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div>© 2025 Thronestead</div>
    <div><a href="legal.html" target="_blank">View Legal Documents</a> <a href="sitemap.xml" target="_blank">Site Map</a></div>
  </footer>
  <script type="module">
    import { supabase } from './supabaseClient.js';

    let currentUserId = null;
    let spyInfo = { spy_count: 0, spy_level: 1 };

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      currentUserId = session.user.id;

      await loadSpyInfo();

      const targetInput = document.getElementById('target-kingdom');
      targetInput.addEventListener('input', e => loadKingdomSuggestions(e.target.value));

      document.getElementById('mission-type').addEventListener('change', updateSuccessRate);
      const qtyInput = document.getElementById('spy-count');
      qtyInput.addEventListener('input', updateSuccessRate);

      document.getElementById('launch-form').addEventListener('submit', launchMission);
    });

    async function loadSpyInfo() {
      try {
        const res = await fetch('/api/kingdom/spies', {
          headers: { 'X-User-ID': currentUserId }
        });
        const data = await res.json();
        spyInfo = data;
        const qtyEl = document.getElementById('spy-count');
        qtyEl.max = data.spy_count || 1;
        qtyEl.value = 1;
        updateSuccessRate();
      } catch (err) {
        console.error('Failed to load spy info', err);
      }
    }

    async function loadKingdomSuggestions(query) {
      const list = document.getElementById('kingdom-list');
      if (!query) return (list.innerHTML = '');
      const { data, error } = await supabase
        .from('kingdoms')
        .select('kingdom_id, kingdom_name')
        .ilike('kingdom_name', `${query}%`)
        .limit(5);
      if (error) {
        console.error('Suggestion error:', error);
        return;
      }
      list.innerHTML = '';
      (data || []).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k.kingdom_name;
        opt.dataset.id = k.kingdom_id;
        list.appendChild(opt);
      });
    }

    function updateSuccessRate() {
      const qty = parseInt(document.getElementById('spy-count').value, 10) || 0;
      const level = spyInfo.spy_level || 0;
      const rate = Math.min(95, 30 + level * 5 + qty * 10);
      const rateEl = document.getElementById('success-rate');
      rateEl.textContent = `Estimated Success Rate: ${rate}%`;
    }

    async function launchMission(e) {
      e.preventDefault();
      const name = document.getElementById('target-kingdom').value.trim();
      const list = document.getElementById('kingdom-list');
      const opt = Array.from(list.options).find(o => o.value === name);
      const target_id = opt ? opt.dataset.id : null;
      const mission_type = document.getElementById('mission-type').value;
      const count = parseInt(document.getElementById('spy-count').value, 10) || 1;
      if (!target_id) {
        showResult('Target kingdom not found.');
        return;
      }
      try {
        const res = await fetch('/api/spy/launch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': currentUserId
          },
          body: JSON.stringify({
            target_kingdom_name: name,
            mission_type,
            num_spies: count
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Launch failed');
        const msg = `Success: ${data.success ? 'Yes' : 'No'} | Accuracy: ${data.accuracy || '?'}% | Caught: ${data.caught ? 'Yes' : 'No'} | Spies Lost: ${data.spies_lost ?? '?'}`;
        showResult(msg);
      } catch (err) {
        showResult('Error: ' + err.message);
      }
    }

    function showResult(text) {
      const el = document.getElementById('mission-results');
      el.textContent = text;
    }
  </script>
</body>
</html>
