<!--
Project Name: Thronestead¬©
File Name: donate_vip.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Donate & VIP | Thronestead</title>
  <meta name="description" content="Support Thronestead and unlock exclusive VIP rewards and cosmetic bonuses." />
  <meta name="keywords" content="Thronestead, donate, VIP, rewards, cosmetics, support" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.thronestead.com/donate_vip.html" />

  <!-- Open Graph -->
  <meta property="og:title" content="Donate & VIP | Thronestead" />
  <meta property="og:description" content="Support Thronestead and unlock exclusive VIP rewards and cosmetic bonuses." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:url" content="donate_vip.html" />
  <meta property="og:type" content="website" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Donate & VIP | Thronestead" />
  <meta name="twitter:description" content="Support the game and unlock exclusive cosmetic VIP rewards in Thronestead." />
  <meta name="twitter:image" content="Assets/banner_main.png" />

  <!-- CSS -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />
  <link href="/CSS/donate_vip.css" rel="stylesheet" />

  <!-- JS Modules (inline script located at bottom of page) -->

<!-- ‚úÖ Injected standard Thronestead modules -->
  <script src="/Javascript/components/authGuard.js" type="module"></script>
  <script src="/Javascript/apiHelper.js" type="module"></script>
  <script src="/Javascript/navLoader.js" type="module"></script>
  <script src="/Javascript/resourceBar.js" type="module"></script>
</head>

<body class="donate-vip-bg">
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>

  <!-- Navbar -->

  <!-- Page Banner -->
  <header class="kr-top-banner" aria-label="Donate & VIP Banner">
    üéÅ Thronestead ‚Äî Donate & VIP
  </header>

  <!-- Main Interface -->
  <main class="donate-vip-container" aria-label="Donate & VIP Interface">

    <!-- Donation Info Panel -->
    <section class="alliance-members-container">

      <h2>Donate &amp; Get Tokens</h2>
      <p>
        Support the development of <strong>Thronestead</strong> and receive <strong>Black Market Tokens</strong> to purchase VIP or other perks.<br />
        <em>Tokens grant cosmetic benefits only.</em>
      </p>

      <div id="current-status-banner" class="vip-expiry-banner" aria-live="polite"></div>
      <div id="vip-timer" class="vip-expiry-banner"></div>
      <div id="token-balance-banner" class="vip-expiry-banner"></div>
      <div id="founder-preview" class="founder-badge" hidden></div>

      <!-- Token Packages (JS Injected) -->
      <div id="token-package-cards" class="vip-tier-cards" aria-label="Token Packages"></div>

      <!-- Redeemable Perks -->
      <h3>Redeem Tokens</h3>
      <div id="redeem-cards" class="vip-tier-cards" aria-label="Redeem Options"></div>

      <!-- Donation Form -->
      <form id="donation-form" class="vip-donation-form" hidden aria-label="Donation Form">
        <input type="hidden" id="selected-tier-id" />
        <button type="submit" class="vip-button">üíé Donate</button>
      </form>

      <!-- PayPal Donation Button -->
      <form action="https://www.paypal.com/ncp/payment/YB4LW7XRELJBS" method="post" target="_blank">
        <input class="pp-YB4LW7XRELJBS" type="submit" value="Buy Now" />
        <img src="https://www.paypalobjects.com/images/Debit_Credit_APM.svg" alt="cards" />
        <section>
          Powered by
          <img src="https://www.paypalobjects.com/paypal-ui/logos/svg/paypal-wordmark-color.svg" alt="paypal" />
        </section>
      </form>

      <!-- VIP Leaderboard -->
      <section class="vip-leaderboard" aria-label="VIP Leaderboard">
        <h3>üèÜ Top Donors</h3>
        <div class="leaderboard-container">
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th scope="col">Rank</th>
                <th scope="col">Player</th>
                <th scope="col">Gold Donated</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body" aria-live="polite">
              <tr>
                <td colspan="3">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      <!-- VIP Terms & Perks -->
      <section class="vip-terms" aria-label="VIP Terms & Perks">
        <h3>VIP Terms &amp; Perks</h3>
        <p>
          VIP tiers grant <strong>cosmetic</strong> rewards only. They provide no gameplay advantages or pay-to-win boosts.
        </p>
        <p>
          Tokens and VIP status unlock visual flair like badges and styling effects without impacting combat or resources.
        </p>
      </section>


    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div>¬© 2025 Thronestead</div>
    <div>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_PrivacyPolicy.pdf">Privacy Policy</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_TermsofService.pdf">Terms of Service</a>
      <a target="_blank" rel="noopener noreferrer" href="Assets/legal/THRONESTEAD_EULA.pdf">EULA</a>
      <a href="legal.html" target="_blank">More Legal</a> <a href="sitemap.xml" target="_blank">Site Map</a>
    </div>
  </footer>

  <!-- VIP Page Logic -->
  <script type="module">
    // Project Name: Thronestead¬©
    // File Name: donate_vip.js
    // Version:  7/1/2025 10:38
    // Developer: Deathsgift66

    import { supabase } from '/Javascript/supabaseClient.js';
    import { escapeHTML } from '/Javascript/utils.js';
    import { authHeaders } from '/Javascript/auth.js';

    const TOKEN_PACKAGES = [
      { package_id: 1, name: '1 Token', price_usd: 3.99, tokens: 1 },
      { package_id: 2, name: '3 Tokens', price_usd: 9.99, tokens: 3 }
    ];

    const REDEEM_OPTIONS = [
      {
        perk_id: 'vip1',
        name: 'VIP 1',
        cost: 1,
        type: 'Cosmetic',
        description: 'Gold username and chat badge',
        details: ['Gold username', 'VIP chat badge', 'Custom troop names']
      },
      {
        perk_id: 'vip2',
        name: 'VIP 2',
        cost: 2,
        type: 'Cosmetic',
        description: 'Extra cosmetics and founder badge',
        details: [
          'All VIP1 perks',
          'Custom troop image',
          'VIP vault skin',
          'Founder badge if subscribed 6+ months'
        ]
      }
    ];

    let tokenPackages = [];
    let vipChannel = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      await Promise.all([
        loadPlayerVIPStatus(),
        loadTokenPackages(),
        loadTokenBalance(),
        loadLeaderboard()
      ]);
      setupRealtimeChannel();
      bindDonationForm();
    });

    window.addEventListener('beforeunload', () => {
      if (vipChannel) supabase.removeChannel(vipChannel);
    });

    function setupRealtimeChannel() {
      vipChannel = supabase
        .channel('public:vip_donations')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'vip_donations' }, () => {
          loadLeaderboard();
        })
        .subscribe();
    }

    async function loadPlayerVIPStatus() {
      try {
        const res = await fetch('/api/vip/status', { headers: await authHeaders() });
        if (!res.ok) throw new Error('Failed to fetch VIP status');
        const status = await res.json();
        renderStatus(status);
      } catch (err) {
        console.warn('VIP status unavailable', err);
      }
    }

    async function loadTokenBalance() {
      try {
        const res = await fetch('/api/tokens/balance', { headers: await authHeaders() });
        if (!res.ok) throw new Error('balance');
        const data = await res.json();
        const banner = document.getElementById('token-balance-banner');
        if (banner) banner.textContent = `${data.tokens} Token${data.tokens === 1 ? '' : 's'} available`;
      } catch {
        const banner = document.getElementById('token-balance-banner');
        if (banner) banner.textContent = 'Tokens unavailable';
      }
    }

    function renderStatus(status) {
      const banner = document.getElementById('current-status-banner');
      const badge = document.getElementById('founder-preview');

      if (!banner) return;

      if (status.vip_level) {
        banner.innerHTML = `\u{1F396}\uFE0F Your Status: <strong>VIP ${status.vip_level}</strong> \u2014 Active until ${new Date(status.expires_at).toLocaleDateString()}`;
        renderTimer(status.expires_at);
      } else {
        banner.innerHTML = `\u{1F9D9} You are not currently a VIP.`;
      }

      if (status.founder) {
        badge.innerHTML = `\u{1F451} Founder Badge Active`;
        badge.hidden = false;
      } else {
        badge.hidden = true;
      }
    }

    async function loadTokenPackages() {
      tokenPackages = TOKEN_PACKAGES;
      renderPackages(tokenPackages);
      renderRedeemables(REDEEM_OPTIONS);
    }

    function renderPackages(packs) {
      const container = document.getElementById('token-package-cards');
      if (!container) return;
      container.innerHTML = '';

      packs.forEach(pack => {
        const card = document.createElement('div');
        card.className = 'vip-card';
        card.dataset.packageId = pack.package_id;
        card.innerHTML = `
      <h3>${escapeHTML(pack.name)}</h3>
      <p>$${pack.price_usd.toFixed(2)}</p>
      <button onclick="selectPackage(${pack.package_id})" class="vip-button">Select</button>
    `;
        container.appendChild(card);
      });
    }

    function renderRedeemables(options) {
      const container = document.getElementById('redeem-cards');
      if (!container) return;
      container.innerHTML = '';

      options.forEach(perk => {
        const card = document.createElement('div');
        card.className = 'vip-card';
        card.setAttribute('data-bs-toggle', 'tooltip');
        card.title = perk.details.join(', ');
        card.innerHTML = `
      <h3>${escapeHTML(perk.name)}</h3>
      <p>${perk.cost} Token${perk.cost > 1 ? 's' : ''}</p>
      <p class="perk-type">${escapeHTML(perk.type)}</p>
      <p class="perk-desc">${escapeHTML(perk.description)}</p>
      <button onclick="redeemPerk('${perk.perk_id}')" class="vip-button">Redeem</button>
    `;
        container.appendChild(card);
        if (window.bootstrap) new window.bootstrap.Tooltip(card);
      });
    }

    function selectPackage(packId) {
      const container = document.getElementById('token-package-cards');
      if (container) {
        container.querySelectorAll('.vip-card').forEach(card => {
          card.classList.toggle('selected', card.dataset.packageId == packId);
        });
      }
      document.getElementById('selected-tier-id').value = packId;
      document.getElementById('donation-form').hidden = false;
    }

    function bindDonationForm() {
      const form = document.getElementById('donation-form');
      if (!form) return;

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const packageId = parseInt(document.getElementById('selected-tier-id').value);
        if (!packageId) return alert('Please select a package.');
        await purchaseTokens(packageId);
      });
    }

    async function purchaseTokens(package_id) {
      try {
        const res = await fetch('/api/tokens/buy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(await authHeaders())
          },
          body: JSON.stringify({ package_id })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Donation failed');

        await loadTokenBalance();
        document.getElementById('donation-form').hidden = true;
        alert('Tokens added!');
      } catch (err) {
        console.error('Donation failed', err);
        alert('Donation failed. Please try again.');
      }
    }

    async function redeemPerk(perk_id) {
      try {
        const res = await fetch('/api/tokens/redeem', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(await authHeaders())
          },
          body: JSON.stringify({ perk_id })
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Redeem failed');
        await Promise.all([loadPlayerVIPStatus(), loadTokenBalance()]);
        alert('Perk redeemed!');
      } catch (err) {
        console.error('Redeem failed', err);
        alert('Redeem failed.');
      }
    }

    function renderPerks(tier) {
      const container = document.getElementById('founder-preview');
      if (container) container.innerHTML = tier.perks || 'No perks listed.';
    }

    function renderTimer(expiry) {
      const timerEl = document.getElementById('vip-timer');
      if (!timerEl || !expiry) return;

      function update() {
        const remaining = new Date(expiry) - new Date();
        if (remaining <= 0) {
          timerEl.textContent = 'expired';
          clearInterval(interval);
          return;
        }
        const d = Math.floor(remaining / 86400000);
        const h = Math.floor((remaining % 86400000) / 3600000);
        const m = Math.floor((remaining % 3600000) / 60000);
        const s = Math.floor((remaining % 60000) / 1000);
        timerEl.textContent = `${d}d ${h}h ${m}m ${s}s`;
      }

      update();
      const interval = setInterval(update, 1000);
    }

    async function loadLeaderboard() {
      const table = document.getElementById('leaderboard-body');
      if (!table) return;
      table.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

      try {
        const res = await fetch('/api/vip/leaderboard', { headers: await authHeaders() });
        const { leaders = [] } = await res.json();
        renderLeaderboard(leaders);
      } catch (err) {
        console.error('Leaderboard error', err);
        table.innerHTML = "<tr><td colspan='3'>Error loading leaderboard</td></tr>";
      }
    }

    function renderLeaderboard(leaders) {
      const table = document.getElementById('leaderboard-body');
      if (!table) return;
      table.innerHTML = '';

      if (leaders.length === 0) {
        table.innerHTML = "<tr><td colspan='3'>No donations yet.</td></tr>";
        return;
      }

      leaders.forEach((l, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHTML(l.username)}</td>
      <td>${l.total_donated}</td>
    `;
        table.appendChild(row);
      });
    }
  </script>

</body>
</html>
