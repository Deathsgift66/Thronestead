<!--
Project Name: Thronestead¬©
File Name: tutorial.html
Version:  7/1/2025 10:38
Developer: Deathsgift66
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; frame-ancestors 'none';" />

  <title>Tutorial | Thronestead</title>
  <meta name="description" content="Learn how to play Thronestead ‚Äî explore the tutorial and master kingdom strategy, diplomacy, and war." />
  <meta name="keywords" content="Thronestead, tutorial, how to play, guide, kingdom management, strategy, diplomacy, war" />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="Tutorial | Thronestead" />
  <meta property="og:description" content="Learn how to play Thronestead ‚Äî explore the tutorial and master kingdom strategy, diplomacy, and war." />
  <meta property="og:image" content="Assets/banner_main.png" />
  <meta property="og:image:alt" content="Thronestead banner" />
  <meta property="og:url" content="tutorial.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Tutorial | Thronestead" />
  <meta name="twitter:description" content="Learn how to play Thronestead ‚Äî explore the tutorial and master kingdom strategy, diplomacy, and war." />
  <meta name="twitter:image" content="Assets/banner_main.png" />
  <meta name="twitter:image:alt" content="Thronestead banner" />
  <link rel="canonical" href="https://www.thronestead.com/tutorial.html" />
  <meta name="theme-color" content="#2e2b27" />

  <!-- Page-Specific Assets -->
  <link href="/CSS/tutorial.css" rel="stylesheet" />

  <!-- Global Assets -->
  <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
  <link href="/CSS/root_theme.css" rel="stylesheet" />
  <link href="/CSS/kr_navbar.css" rel="stylesheet" />
  <link href="/CSS/resource_bar.css" rel="stylesheet" />

<!-- ‚úÖ Injected standard Thronestead modules -->
  <script src="/Javascript/components/auth-guard.js" type="module"></script>
  <script src="/Javascript/api-helper.js" type="module"></script>
  <script src="/Javascript/nav-loader.js" type="module"></script>
  <script src="/Javascript/modal-fallback.js" type="module"></script>
  <script src="/Javascript/resource-bar.js" type="module"></script>
</head>

<body>
  <noscript>
    <div class="noscript-warning">
      JavaScript is disabled in your browser. Some features of Thronestead may not function correctly.
    </div>
  </noscript>

<div id="navbar-container"></div>
<div id="resource-bar-container"></div>

<!-- Navbar -->

<!-- Page Banner -->
<header class="kr-top-banner" aria-label="Tutorial Banner">
  Thronestead ‚Äî Tutorial
</header>

<!-- Main Content -->
<main role="main" id="main-content" class="main-centered-container" aria-label="Tutorial Interface">

  <!-- Tutorial Progress + Steps -->
  <section class="alliance-members-container" role="region" aria-labelledby="tutorial-section">
    <h2 id="tutorial-section" class="visually-hidden">Tutorial Progress and Steps</h2>
    <div id="progress-container" class="progress-bar-bg" aria-label="Tutorial Progress">
      <div id="progress-bar" class="progress-bar-fill" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
    </div>
    <div id="steps" class="tutorial-scroll custom-scrollbar" aria-live="polite"></div>
  </section>

</main>

<!-- Tutorial Modal -->
  <div id="tutorialModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
  <div class="modal-content">
    <h2 id="modal-title" class="visually-hidden">Tutorial</h2>
    <button id="tutorialClose" class="close-btn" aria-label="Close tutorial modal">&times;</button>

    <nav class="tutorial-tabs" role="tablist" aria-label="Tutorial Topics">
      <button class="tab" data-step="0" role="tab" aria-selected="true" id="tab-intro">Introduction</button>
      <button class="tab" data-step="1" role="tab" id="tab-cities">Cities</button>
      <button class="tab" data-step="2" role="tab" id="tab-projects">Projects</button>
      <button class="tab" data-step="3" role="tab" id="tab-trading">Trading</button>
      <button class="tab" data-step="4" role="tab" id="tab-wars">Wars</button>
      <button class="tab" data-step="5" role="tab" id="tab-alliances">Alliances</button>
    </nav>

    <!-- Tutorial Panels -->
    <div id="panel-0" class="tutorial-panel active" role="tabpanel" aria-labelledby="tab-intro">
      <p>Welcome to Thronestead! This tutorial will guide you through the basics of the realm.</p>
      <button class="royal-button continue-btn">Continue</button>
    </div>
    <div id="panel-1" class="tutorial-panel" role="tabpanel" aria-labelledby="tab-cities">
      <p>Cities are the backbone of your kingdom. Construct buildings to expand your influence.</p>
      <button class="royal-button continue-btn">Continue</button>
    </div>
    <div id="panel-2" class="tutorial-panel" role="tabpanel" aria-labelledby="tab-projects">
      <p>Projects let you develop advanced capabilities and unique kingdom upgrades.</p>
      <button class="royal-button continue-btn">Continue</button>
    </div>
    <div id="panel-3" class="tutorial-panel" role="tabpanel" aria-labelledby="tab-trading">
      <p>Trading with other players is key to acquiring rare resources and wealth.</p>
      <button class="royal-button continue-btn">Continue</button>
    </div>
    <div id="panel-4" class="tutorial-panel" role="tabpanel" aria-labelledby="tab-wars">
      <p>Wars determine dominance. Train troops and strategize carefully.</p>
      <button class="royal-button continue-btn">Continue</button>
    </div>
    <div id="panel-5" class="tutorial-panel" role="tabpanel" aria-labelledby="tab-alliances">
      <p>Alliances offer strength in numbers. Work together to conquer your foes.</p>
      <button class="royal-button continue-btn">Finish</button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="site-footer" role="contentinfo">
  <div>¬© 2025 Thronestead</div>
  <div><a href="legal.html" target="_blank">View Legal Documents</a> <a href="sitemap.xml" target="_blank">Site Map</a></div>
</footer>

  <!-- Page-specific scripts -->
  <script type="module">
// Project Name: Thronestead¬©
// File Name: tutorial.js (inlined)
// Version:  7/1/2025 10:38
// Developer: Deathsgift66
import { supabase } from '/Javascript/supabase-client.js';
import { escapeHTML } from '/Javascript/core-utils.js';
import { initCsrf, getCsrfToken } from '/Javascript/security/csrf.js';

initCsrf();

let currentUser = null;
let tutorialChannel;

document.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return (window.location.href = "login.html");
  currentUser = session.user;

  await loadSteps();
  setupRealtime();
  initScrollAnimations();
  setupProgressBar();
});

// ‚úÖ Smooth fade-in animation for tutorial steps
function initScrollAnimations() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      entry.target.classList.toggle('visible', entry.isIntersecting);
    });
  }, { threshold: 0.15 });

  document.querySelectorAll('.tutorial-step').forEach(step => observer.observe(step));
}

// ‚úÖ Load tutorial steps from API
async function loadSteps() {
  const container = document.getElementById('steps');
  container.innerHTML = '<p>üìú Loading tutorial steps...</p>';
  try {
    const res = await fetch('/api/tutorial/steps', {
      headers: {
        'X-User-ID': currentUser.id,
        'X-CSRF-Token': getCsrfToken()
      }
    });
    const { steps } = await res.json();
    renderSteps(steps || []);
  } catch (err) {
    console.error('‚ùå Error loading tutorial steps:', err);
    container.innerHTML = `<p>‚ö†Ô∏è Failed to load steps. <button onclick="location.reload()">Retry</button></p>`;
  }
}

// ‚úÖ Render steps into DOM
function renderSteps(steps) {
  const container = document.getElementById('steps');
  container.innerHTML = '';

  if (steps.length === 0) {
    container.innerHTML = '<p>No tutorial steps found.</p>';
    return;
  }

  steps.forEach(step => {
    const div = document.createElement('div');
    div.className = 'tutorial-step';
    div.setAttribute('tabindex', '0');
    div.setAttribute('role', 'region');
    div.setAttribute('aria-label', `Tutorial Step ${step.step_number}: ${step.title}`);

    div.innerHTML = `
      <h3>Step ${step.step_number}: ${escapeHTML(step.title)}</h3>
      <p>${escapeHTML(step.description)}</p>
    `;
    container.appendChild(div);
  });

  // Scroll to top when reloaded
  container.scrollTo({ top: 0, behavior: 'smooth' });
}

// ‚úÖ Subscribe to live tutorial step updates
function setupRealtime() {
  tutorialChannel = supabase
    .channel('public:tutorial_steps')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'tutorial_steps'
    }, async () => {
      await loadSteps();
    })
    .subscribe();

  window.addEventListener('beforeunload', async () => {
    if (tutorialChannel) await supabase.removeChannel(tutorialChannel);
  });
}

// ‚úÖ Progress bar tracker
function setupProgressBar() {
  const container = document.getElementById('steps');
  const bar = document.getElementById('progress-bar');
  if (!container || !bar) return;

  let ticking = false;
  container.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        const percent = (container.scrollTop / (container.scrollHeight - container.clientHeight)) * 100;
        bar.style.width = `${percent.toFixed(1)}%`;
        bar.setAttribute('aria-valuenow', percent.toFixed(1));
        ticking = false;
      });
      ticking = true;
    }
  });
}
</script>

  <script>
// Project Name: Thronestead¬©
// File Name: tutorialModal.js (inlined)
// Version:  7/1/2025 10:38
// Developer: Deathsgift66
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('tutorialModal');
  const closeBtn = document.getElementById('tutorialClose');
  const tabs = document.querySelectorAll('#tutorialModal .tab');
  const panels = document.querySelectorAll('#tutorialModal .tutorial-panel');
  const continueBtns = document.querySelectorAll('#tutorialModal .continue-btn');
  const focusableSelectors = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';

  let currentStep = parseInt(getCookie('tutorialStep') || '0', 10);
  if (Number.isNaN(currentStep) || currentStep >= panels.length) currentStep = 0;

  const tutorialCompleted = getCookie('tutorialComplete');
  if (!tutorialCompleted) {
    showStep(currentStep);
    openModal();
  }

  // Tab navigation
  tabs.forEach((tab, idx) => {
    tab.addEventListener('click', () => showStep(idx));
    tab.setAttribute('role', 'tab');
    tab.setAttribute('tabindex', '0');
    tab.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        showStep(idx);
        e.preventDefault();
      }
    });
  });

  continueBtns.forEach((btn, idx) => {
    btn.addEventListener('click', () => {
      if (idx < panels.length - 1) {
        showStep(idx + 1);
      } else {
        finishTutorial();
      }
    });
  });

  closeBtn.addEventListener('click', finishTutorial);
  modal.addEventListener('keydown', trapFocus);

  function openModal() {
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    document.body.style.overflow = 'hidden';
    modal.focus();
  }

  function finishTutorial() {
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    setCookie('tutorialComplete', 'true', 60);
    if (typeof window.onTutorialComplete === 'function') {
      window.onTutorialComplete();
    }
  }

  function showStep(n) {
    tabs.forEach((t, i) => {
      t.classList.toggle('active', i === n);
      t.setAttribute('aria-selected', i === n);
    });
    panels.forEach((p, i) => p.classList.toggle('active', i === n));
    setCookie('tutorialStep', n, 30);
    currentStep = n;
  }

  function setCookie(name, value, days) {
    try {
      const d = new Date();
      d.setTime(d.getTime() + days * 86400000);
      const domain = location.hostname.includes('localhost') ? '' : `domain=${location.hostname}; `;
      document.cookie =
        `${name}=${value}; expires=${d.toUTCString()}; path=/; ${domain}secure; samesite=strict`;
    } catch (err) {
      console.warn("Cookies are disabled or blocked:", err);
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }


  function trapFocus(e) {
    if (e.key !== 'Tab') return;
    const focusables = Array.from(modal.querySelectorAll(focusableSelectors)).filter(el => !el.disabled && el.getAttribute('tabindex') !== '-1');
    if (!focusables.length) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        e.preventDefault();
      }
    }
  }
});
</script>

  <!-- Backend route definition for reference
  <script type="text/python">
from fastapi import APIRouter, Depends, HTTPException

from ..security import require_user_id
from ..supabase_client import get_supabase_client

router = APIRouter(prefix="/api/tutorial", tags=["tutorial"])


@router.get("/steps", summary="Get Tutorial Steps")
async def steps(user_id: str = Depends(require_user_id)):
    """
    Fetch ordered tutorial steps from the 'tutorial_steps' table for the authenticated user.
    This ensures only valid players can access in-game tutorials.
    """
    supabase = get_supabase_client()

    # Validate user exists
    try:
        user_check = (
            supabase.table("users")
            .select("user_id")
            .eq("user_id", user_id)
            .single()
            .execute()
        )
        if getattr(user_check, "error", None) or not getattr(user_check, "data", None):
            raise HTTPException(status_code=401, detail="Invalid user")
    except Exception as exc:
        raise HTTPException(status_code=500, detail="Failed to validate user") from exc

    # Fetch tutorial steps in order
    try:
        res = (
            supabase.table("tutorial_steps")
            .select("id,title,description,step_number")
            .order("step_number")
            .execute()
        )
        rows = getattr(res, "data", res) or []
    except Exception as exc:
        raise HTTPException(
            status_code=500, detail="Failed to load tutorial steps"
        ) from exc

    # Return structured tutorial list
    steps = [
        {
            "step_id": r.get("id"),
            "title": r.get("title"),
            "description": r.get("description"),
            "step_number": r.get("step_number"),
        }
        for r in rows
    ]

    return {"steps": steps}
  </script>
  -->

</body>
</html>
